<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>學生招聘個案 (學術)</title>
  <style>
    :root{
      /* ✅ CHANGED: follow your reference dark blue-grey theme */
      --bg:#0F172A;
      --surface:#1E293B;
      --card:#1E293B;
      --muted:#94A3B8;
      --text:#F8FAFC;
      --heading:#F8FAFC;
      --ring:#334155;
      --accent:#38BDF8;
      --accentHover:#0EA5E9;
      --shadow:0 8px 22px rgba(0,0,0,.45);
      --radius:16px;
      --modalBg:rgba(0,0,0,.65);
      --tagBg:#1E293B;
      --tagBorder:#334155;
      --tagText:#F8FAFC;
      --glassBlur: 14px;

      /* slider (match reference) */
      --rangeFill: var(--accent);
      --rangeRest: #ffffff;
      --rangeBorder: rgba(56,189,248,.55);
      --rangeThumb: #ffffff;

      /* accent button spec (全選 / 清除全部 / 套用篩選) */
      --actBg: var(--accent);            /* #38BDF8 */
      --actText: #0F172A;
      --actBorder: rgba(56,189,248,.55);
      --actBgHover: var(--accentHover);  /* #0EA5E9 */
      --actBorderHover: rgba(56,189,248,.85);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    html{ scroll-behavior: smooth; }
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, -apple-system, "Noto Sans TC", system-ui, "PingFang TC", "Microsoft JhengHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background:
        radial-gradient(900px 400px at 10% -10%, rgba(56,189,248,.18) 0%, rgba(56,189,248,0) 60%),
        radial-gradient(800px 500px at 110% 0%, rgba(14,165,233,.12) 0%, rgba(14,165,233,0) 55%),
        var(--bg);
      -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      overflow-x:hidden;
    }
    .container{max-width:1200px; margin:26px auto 80px; padding:0 20px;}

    .topbar{
      position: sticky;
      top: 0;
      z-index: 30;
      backdrop-filter: blur(var(--glassBlur));
      -webkit-backdrop-filter: blur(var(--glassBlur));
      background: rgba(255,255,255,.06);
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    .topbar-inner{
      max-width: 1200px;
      margin: 0 auto;
      padding: 12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }

    .logo{
      width: 40px; height: 40px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      display:grid; place-items:center;
      flex: 0 0 auto;
      color: rgba(248,250,252,.92);
    }
    .logo svg{ width: 22px; height: 22px; }
    .logo svg path{ stroke: currentColor !important; }

    .brandText{
      line-height: 1.05;
      min-width: 0;
    }
    .brandText .title{
      font-weight: 950;
      letter-spacing: .12em;
      font-size: 13px;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .brandText .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .menuBtn{
      width: 44px;
      height: 44px;
      border-radius: 16px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      color: rgba(248,250,252,.92);
      cursor:pointer;
      transition: transform .16s ease, border-color .16s ease, background .16s ease;
    }
    .menuBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.07);
    }
    .menuBtn:active{ transform: translateY(0) scale(.99); }
    .menuBtn svg{ width: 22px; height: 22px; }
    .menuBtn svg path{ stroke: currentColor !important; }

    .overlay{
      position: fixed;
      inset: 0;
      background: var(--modalBg);
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s ease;
      z-index: 40;
    }
    .overlay.open{
      opacity: 1;
      pointer-events: auto;
    }

    .drawer{
      position: fixed;
      top: 0;
      right: 0;
      height: 100%;
      width: min(92vw, 360px);
      transform: translateX(105%);
      transition: transform .28s cubic-bezier(.2,.8,.2,1);
      z-index: 50;

      background: rgba(255,255,255,.06);
      border-left: 1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: -18px 0 60px rgba(0,0,0,.45);
      overflow: hidden;
    }
    .drawer.open{ transform: translateX(0); }

    .drawer::before{
      content:"";
      position:absolute; inset:0;
      background:
        radial-gradient(520px 240px at 20% 20%, rgba(167,139,250,.12), transparent 60%),
        radial-gradient(520px 260px at 90% 30%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(560px 340px at 60% 90%, rgba(167,139,250,.12), transparent 70%);
      opacity:.9;
      pointer-events:none;
    }

    .drawerInner{
      position: relative;
      height: 100%;
      display:flex;
      flex-direction:column;
      padding: 16px 16px 14px;
      gap: 12px;
    }

    .drawerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 6px;
    }
    .drawerTitle{
      font-weight: 800;
      letter-spacing: .08em;
      font-size: 13px;
      text-transform: uppercase;
      color: rgba(248,250,252,.92);
    }

    .closeBtn{
      width: 36px;
      height: 36px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      color: rgba(248,250,252,.92);
      cursor:pointer;
      transition: transform .16s ease, border-color .16s ease, background .16s ease;
    }
    .closeBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.20);
      background: rgba(255,255,255,.08);
    }
    .closeBtn:active{ transform: translateY(0) scale(.98); }
    .closeBtn svg{ width: 18px; height: 18px; }
    .closeBtn svg path{ stroke: currentColor !important; }

    .navList{
      display:flex;
      flex-direction:column;
      gap: 8px;
    }
    .navItem{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      text-decoration:none;
      padding: 12px 14px;
      border-radius: 14px;
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      color: rgba(248,250,252,.94);
      transition: transform .16s ease, border-color .16s ease, background .16s ease;
    }
    .navItem:hover{
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.08);
    }
    .navLeft{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
    }
    .navMain{
      font-weight: 600;
      font-size: 14px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .navArrow{
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      flex: 0 0 auto;
    }
    .navArrow svg{ width: 16px; height: 16px; color: rgba(248,250,252,.92); }
    .navArrow svg path{ stroke: currentColor !important; }

    .drawerFoot{
      margin-top: auto;
      font-size: 12px;
      color: rgba(226,232,240,.78);
      padding: 10px 12px 6px;
    }

    @media (max-width: 720px){
      .topbar-inner{ padding: 10px 14px; }
    }

    header:not(.topbar){
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .title{display:flex; align-items:center; gap:10px;}
    .title h1{
      margin:0; font-size:clamp(20px,2.3vw,28px); letter-spacing:.4px;
      color:var(--heading);
    }

    /* 按鈕列 */
    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--ring);
      background:var(--surface);
      color:var(--text);
      cursor:pointer;
      transition: transform .06s ease, border-color .2s, background .2s;
      box-shadow:var(--shadow);
      white-space:nowrap;
      font-size:14px;
    }
    .btn:hover{ border-color: var(--accent); background:#162235 }
    .btn:active{ transform: scale(.98);}

    .filter-btn{display:none;}
    .desktop-only{display:inline-flex;}

    .filter-icon{
      display:inline-flex;
      width:16px; height:16px;
      margin-right:6px;
    }
    .filter-icon svg{width:100%; height:100%;}

    .apply-btn{
      padding:8px 16px;
      border-radius:999px;
      border:1px solid rgba(56,189,248,.55);
      background:var(--accent);
      color:#0F172A;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      transition:background .15s ease, transform .06s ease, box-shadow .15s ease, border-color .15s ease;
      white-space:nowrap;
    }
    .modal header .apply-btn{ margin-right:40px; }
    .apply-btn:hover{background:var(--accentHover); border-color:rgba(56,189,248,.85)}
    .apply-btn:active{
      transform:scale(.97);
      box-shadow:0 4px 14px rgba(56,189,248,.35);
    }

    /* 篩選 + 搜尋列 外層（桌機 + 平板共享） */
    .filter-row{ margin:16px 0 12px; }

    .filters{
      display:grid;
      gap:10px;
      grid-template-columns: 1.1fr 1.1fr 1fr 1fr;
    }
    .search-row{
      display:grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap:10px;
      margin:10px 0 10px;
    }

    .filters .field,
    .search-row .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:var(--muted)}
    .mini{font-size:12px; color:var(--muted)}

    /* ✅ CHANGED: these filter/search "buttons" (select/input) should be white */
    #district,
    #sortDate,
    #genderPref,
    #q,
    #idq{
      background:#ffffff !important;
      color:#0F172A !important;
      border-color: rgba(56,189,248,.55) !important;
    }
    #district:focus,
    #sortDate:focus,
    #genderPref:focus,
    #q:focus,
    #idq:focus{
      border-color: rgba(56,189,248,.85) !important;
      box-shadow:0 0 0 3px rgba(56,189,248,.20) !important;
    }

    /* keep dropdown arrow visible on white */
    select{
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, #0F172A 50%),
        linear-gradient(135deg, #0F172A 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 52%,
        calc(100% - 12px) 52%;
      background-size:6px 6px, 6px 6px;
      background-repeat:no-repeat;
      padding-right:34px;
    }

    select, input[type="search"], input[type="text"]{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--ring);
      background:var(--surface); color:var(--text);
      box-shadow:var(--shadow); outline:none; transition:border-color .2s, box-shadow .2s, background .2s;
      font-size:14px;
    }
    select:focus, input:focus{ border-color: var(--accent); box-shadow:0 0 0 3px rgba(56,189,248,.20) }

    .slider-row{display:flex; gap:16px; align-items:flex-start}
    .slider-col{display:flex; flex-direction:column; gap:6px; flex:1}
    .slider-col input[type="range"]{ width:100% }

    /* range (match reference) */
    input[type="range"]{
      -webkit-appearance:none;
      appearance:none;
      height:34px;
      background:transparent;
      cursor:pointer;
      padding:0;
      margin:0;
    }
    input[type="range"]::-webkit-slider-runnable-track{
      height:8px;
      border-radius:999px;
      background: linear-gradient(90deg, var(--rangeFill) 0%, var(--rangeFill) var(--pct, 50%), var(--rangeRest) var(--pct, 50%), var(--rangeRest) 100%);
      border:1px solid var(--rangeBorder);
      box-shadow: 0 1px 0 rgba(255,255,255,.08) inset;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      appearance:none;
      width:18px; height:18px;
      border-radius:999px;
      background:var(--rangeThumb);
      border:2px solid rgba(56,189,248,.85);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
      margin-top:-6px;
    }
    input[type="range"]::-moz-range-track{
      height:8px;
      border-radius:999px;
      background: var(--rangeRest);
      border:1px solid var(--rangeBorder);
    }
    input[type="range"]::-moz-range-progress{
      height:8px;
      border-radius:999px;
      background: var(--rangeFill);
    }
    input[type="range"]::-moz-range-thumb{
      width:18px; height:18px;
      border-radius:999px;
      background:var(--rangeThumb);
      border:2px solid rgba(56,189,248,.85);
      box-shadow: 0 10px 18px rgba(0,0,0,.35);
    }

    /* 價位下拉（手機用） */
    #feeBand{
      display:none;
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--ring);
      background:var(--surface);
      box-shadow:var(--shadow);
      color:var(--text);
    }

    .meta{display:flex; align-items:center; gap:10px; margin:10px 2px 18px; color:var(--muted); font-size:14px;}

    .active-bar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:8px 0 16px;}
    .hidden{display:none}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--tagBorder); background:var(--tagBg); color:var(--tagText);
      box-shadow:var(--shadow);
    }
    .chip .x{
      border:none; background:transparent; cursor:pointer; font-size:14px; line-height:1;
      color:var(--text); padding:0 2px 0 0;
      opacity:.9;
    }

    .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;}
    @media (max-width:980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:560px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      border:1px solid var(--ring);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      transition: transform .15s ease, border-color .2s, background .2s;
      cursor:pointer;
    }
    .card:hover{ transform: translateY(-3px); border-color: rgba(56,189,248,.85); background:#18253a }
    .card:focus{ outline: none; border-color:var(--accent); box-shadow:0 0 0 3px rgba(56,189,248,.25)}
    .top{display:flex; align-items:center; gap:12px; margin-bottom:10px;}
    .avatar{
      width:38px; height:38px; border-radius:50%; display:grid; place-items:center; color:#fff; font-weight:800; letter-spacing:.5px;
      border: 1px solid rgba(255,255,255,.08);
    }
    .who{display:flex; flex-direction:column; gap:3px;}
    .who .name{font-weight:700}
    .who .muted{color:var(--muted); font-size:13px}
    .row{display:flex; align-items:center; gap:8px; margin:8px 0; color:var(--text); font-size:14px}
    .row svg{opacity:.95}
    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
    .tag{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--tagBorder); background:var(--tagBg); color:var(--tagText);}
    .foot{margin-top:12px; display:flex; align-items:center; justify-content:space-between; gap:8px; color:var(--muted); font-size:13px;}
    .budget{color:var(--accent); font-weight:800}
    .note{margin-top:10px; color:rgba(248,250,252,.88); font-size:14px; line-height:1.5}
    .empty{grid-column:1/-1; text-align:center; padding:40px 16px; color:var(--muted); border:1px dashed var(--ring); border-radius:var(--radius); background:var(--surface)}

    .modal-backdrop{
      position:fixed; inset:0; background:var(--modalBg);
      display:none; align-items:center; justify-content:center;
      z-index:50; padding:16px;
    }
    .modal-backdrop.show{display:flex}

    .modal{
      width:min(920px, 96vw); max-height:90vh; overflow:auto; background:var(--surface);
      border:1px solid var(--ring); border-radius:22px; box-shadow: 0 25px 70px rgba(0,0,0,.55);
      position:relative;
    }
    .modal header{
      padding:18px 20px 0 20px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      position:relative;
    }
    .modal .body{padding: 4px 20px 20px}
    .modal .close{
      border:none; background:transparent; color:var(--accent); cursor:pointer; font-size:22px;
      position:absolute; top:14px; right:18px;
    }

    .profile-grid{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:18px;
      margin-top:6px;
      justify-items:stretch;
    }
    .profile-card{
      background:#152238;
      border:1px solid var(--ring);
      border-radius:16px;
      padding:14px;
    }
    .profile-title{margin:0 0 8px 0; font-size:15px; color:var(--accent)}
    .kv{display:grid; grid-template-columns: 120px 1fr; gap:8px 12px; font-size:14px}
    .kv b{color:var(--text); font-weight:700}
    .cta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .copy{cursor:pointer; border:1px solid var(--ring); background:var(--surface); color:var(--text); padding:8px 10px; border-radius:10px; box-shadow:var(--shadow)}
    .copy:hover{border-color:rgba(56,189,248,.85); background:#162235}

    @media (max-width:560px){
      .profile-grid{ grid-template-columns:1fr; justify-items:center; }
      .profile-card{ max-width:520px; width:100%; }
    }

    .pager{display:flex; align-items:center; justify-content:center; gap:10px; margin-top:16px; flex-wrap:wrap}

    /* ✅ CHANGED ONLY: 上一頁/下一頁/第 x / y 頁 字色改為純白 #FFFFFF */
    .pagebtn{border:1px solid #FFFFFF; background:#FFFFFF; color:#0F172A; padding:8px 12px; border-radius:10px; cursor:pointer}
    .pagebtn:hover{border-color:rgba(56,189,248,.85)}
    .pagebtn[disabled]{opacity:.5; cursor:not-allowed}
    .pageinfo{font-size:13px; color:#FFFFFF}

    .subgrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px 12px;
      margin-top:10px;
    }
    .subgrid label{display:flex; gap:8px; align-items:center; font-size:13px; color:var(--text)}
    .subgrid input{width:16px; height:16px}
    .line{border:none; border-top:1px solid var(--ring); margin:12px 0}
    .bar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .fw{width:100%}
    .fee-label{}

    /* 手機 toolbar + 搜尋列 + 其他手機樣式 */
    @media (max-width:560px){
      .toolbar{
        width:100%;
        display:grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap:8px;
        margin-top:8px;
      }
      .toolbar .btn{ width:100%; }
      #resetAll{ grid-column:1 / -1; }
      .filter-btn{ display:inline-flex; }
      .desktop-only{ display:none; }

      .search-row{
        display:flex;
        gap:8px;
        margin:10px 0 10px;
      }
      .search-row .field{flex:1;}
    }

    /* 手機：filter bottom sheet、科目清單一欄並可捲動 */
    .filter-panel{
      width:100%;
      max-width:640px;
      margin:0 auto;
      background:var(--surface);
      border-radius:18px 18px 0 0;
      box-shadow:0 -16px 40px rgba(0,0,0,.55);
      border:1px solid var(--ring);
      border-bottom:none;
    }
    .filter-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px 6px;
    }
    .filter-title{
      margin:0;
      font-size:18px;
      color:var(--text);
    }
    .filter-header-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* ✅ 篩選底板「套用篩選」= reference spec */
    .filter-apply-btn{
      padding:6px 12px;
      border-radius:999px;
      border:1px solid var(--actBorder);
      background:var(--actBg);
      color:var(--actText);
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:var(--shadow);
      transition: background .15s ease, border-color .15s ease, transform .06s ease;
    }
    .filter-apply-btn:hover{ background:var(--actBgHover); border-color:var(--actBorderHover); }
    .filter-apply-btn:active{ transform:scale(.98); }

    .filter-close{
      border:none;
      background:transparent;
      font-size:24px;
      cursor:pointer;
      color:var(--text);
    }
    .filter-body{ padding:4px 18px 14px; }

    @media (max-width:560px){
      #filterBackdrop.modal-backdrop{
        align-items:flex-end;
        justify-content:center;
        padding:0;
      }

      .filters{display:none;}
      .filter-panel .filters{
        display:grid;
        grid-template-columns:1fr;
        gap:10px;
        margin:6px 0 6px;
      }

      .fee-label{ font-size:0; }
      .fee-label::before{
        content:"價位區間";
        font-size:12px;
        color:var(--muted);
      }

      .slider-row,
      #feeLabel{ display:none; }
      #feeBand{ display:block; }

      .subgrid{
        grid-template-columns:1fr;
        max-height:260px;
        overflow-y:auto;
        padding-right:4px;
      }
      .subgrid label{ align-items:center; }
      .subgrid label span{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }
    }

    /* 桌機 + 平板：6 個欄位在同一行 */
    @media (min-width:561px){
      .filter-btn{display:none;}
      .desktop-only{display:inline-flex;}
      #filterBackdrop{display:none !important;}
      .filters{display:grid;}

      .filter-row{
        display:grid;
        grid-template-columns: 1.1fr 1.1fr 1.1fr 1.1fr 1fr 1fr;
        gap:10px;
        align-items:flex-start;
        margin:16px 0 12px;
      }

      .filter-row .filters,
      .filter-row .search-row{
        display:contents;
        margin:0;
      }

      .filter-row .label,
      .filter-row .mini{ white-space:nowrap; }

      .filter-row .filters .field:nth-child(1){ grid-column:1; grid-row:1; }
      .filter-row .filters .field:nth-child(2){ grid-column:2; grid-row:1; }
      .filter-row .filters .field:nth-child(3){ grid-column:5; grid-row:1; }
      .filter-row .filters .field:nth-child(4){ grid-column:6; grid-row:1; }

      .filter-row .search-row .field:nth-child(1){ grid-column:3; grid-row:1; }
      .filter-row .search-row .field:nth-child(2){ grid-column:4; grid-row:1; }
    }

    .filter-row .label,
    .filter-row .mini{ white-space:nowrap; }

    .filter-row .filters .field:nth-child(1){ grid-column:1; }
    .filter-row .filters .field:nth-child(2){ grid-column:2; }
    .filter-row .filters .field:nth-child(3){ grid-column:5; }
    .filter-row .filters .field:nth-child(4){ grid-column:6; }
    .filter-row .search-row .field:nth-child(1){ grid-column:3; }
    .filter-row .search-row .field:nth-child(2){ grid-column:4; }

    /* =========================
       Banner — match reference dark style
       ========================= */
    .banner{
      position:relative;
      width:100%;
      border-radius:22px;
      overflow:hidden;
      padding:22px 20px;
      margin-bottom:14px;

      border:1px solid rgba(56,189,248,.22);
      background:
        radial-gradient(700px 220px at 12% 20%, rgba(56,189,248,.22), transparent 62%),
        radial-gradient(520px 220px at 85% 35%, rgba(14,165,233,.16), transparent 65%),
        linear-gradient(135deg, rgba(30,41,59,.92) 0%, rgba(15,23,42,.92) 55%, rgba(30,41,59,.92) 100%);

      box-shadow:
        0 10px 26px rgba(0,0,0,.38),
        0 1px 0 rgba(255,255,255,.06) inset;
    }
    .banner::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(520px 200px at 18% 10%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(420px 220px at 85% 0%, rgba(255,255,255,.08), transparent 62%);
      opacity:.8;
      pointer-events:none;
    }

    .banner-inner{
      position:relative;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .banner-title{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:280px;
    }

    .logo-wrap{
      width:46px; height:46px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(15,23,42,.65);
      border:1px solid rgba(56,189,248,.22);
      box-shadow: 0 8px 18px rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position:relative;
    }
    .logo-wrap::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:18px;
      background: radial-gradient(circle at 50% 50%, rgba(56,189,248,.18), transparent 62%);
      pointer-events:none;
    }

    .book{ width:28px; height:28px; position:relative; z-index:1; }
    .book path{
      stroke: var(--accent);
      stroke-width:1.7;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .book{
      filter:
        drop-shadow(0 6px 12px rgba(0,0,0,.35))
        drop-shadow(0 0 10px rgba(56,189,248,.14));
    }

    .banner-text h1{
      margin:0;
      font-size:clamp(22px, 2.5vw, 30px);
      letter-spacing:.3px;
      line-height:1.08;
      color:var(--heading);
    }
    .banner-text h1 .accent{
      color: var(--accent);
      font-weight:900;
    }
    .banner-text p{
      margin:7px 0 0;
      color: rgba(148,163,184,.95);
      font-size:13.5px;
      line-height:1.45;
      max-width:680px;
    }

    @media (min-width:981px){
      .banner{
        padding:30px 28px;
        margin-bottom:26px;
      }
      .banner-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .toolbar{
        width:100%;
        justify-content:flex-start;
        margin-top:14px;
      }
    }

    /* ✅ accent buttons (全選 / 清除全部 / 套用篩選) */
    .btn-accent{
      background: var(--actBg);
      color: var(--actText);
      border-color: var(--actBorder);
    }
    .btn-accent:hover{
      background: var(--actBgHover);
      border-color: var(--actBorderHover);
    }

  </style>
</head>
<body>
  <header class="topbar" role="banner">
    <div class="topbar-inner">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none">
            <path d="M3.5 11.5 21 3.5l-8 17-2.5-6-7-3Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
            <path d="M21 3.5 10.5 14.5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="brandText">
          <div class="title">EXPLORER</div>
          <div class="sub">尋找招聘個案（學術）</div>
        </div>
      </div>

      <button class="menuBtn" id="menuBtn" type="button" aria-label="開啟導航列" aria-controls="drawer" aria-expanded="false">
        <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M5 7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M5 17h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </button>
    </div>
  </header>

  <div class="overlay" id="overlay" aria-hidden="true"></div>

  <nav class="drawer" id="drawer" aria-label="導航列" aria-hidden="true">
    <div class="drawerInner">
      <div class="drawerTop">
        <div class="drawerTitle">導航</div>
        <button class="closeBtn" id="closeBtn" type="button" aria-label="關閉導航列">
          <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <path d="M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="navList">
        <a class="navItem" href="/index.html">
          <div class="navLeft"><div class="navMain">主頁</div></div>
          <div class="navArrow" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <a class="navItem" href="/index.html#flowPanel">
          <div class="navLeft"><div class="navMain">配對方法</div></div>
          <div class="navArrow" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <a class="navItem" href="/fees.html">
          <div class="navLeft"><div class="navMain">收費及付款詳情</div></div>
          <div class="navArrow" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <a class="navItem" href="/contact.html">
          <div class="navLeft"><div class="navMain">聯絡我們</div></div>
          <div class="navArrow" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>

        <a class="navItem" href="/terms.html">
          <div class="navLeft"><div class="navMain">使用條款</div></div>
          <div class="navArrow" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none">
              <path d="M9 6l6 6-6 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </div>
        </a>
      </div>

      <div class="drawerFoot">
        點擊空白位置或按 ESC 可關閉導航列。
      </div>
    </div>
  </nav>

  <div class="container">

    <!-- ===== Banner (Title + Buttons combined) ===== -->
    <div class="banner">
      <div class="banner-inner">
        <div class="banner-title">
          <span class="logo-wrap" aria-hidden="true">
            <svg class="book" viewBox="0 0 24 24" fill="none">
              <path d="M12 6.2c-1.2-1.1-2.6-1.7-4.5-1.7H5.8c-1 0-1.8.8-1.8 1.8v11.8c0 1 .8 1.8 1.8 1.8h1.7c1.9 0 3.3.6 4.5 1.7"/>
              <path d="M12 6.2c1.2-1.1 2.6-1.7 4.5-1.7h1.7c1 0 1.8.8 1.8 1.8v11.8c0 1-.8 1.8-1.8 1.8h-1.7c-1.9 0-3.3.6-4.5 1.7"/>
              <path d="M12 6.2v15.6"/>
              <path d="M7.2 8.9h3.7M7.2 11.5h3.7" opacity=".85"/>
              <path d="M13.1 8.9h3.7M13.1 11.5h3.7" opacity=".85"/>
            </svg>
          </span>

          <div class="banner-text">
            <h1>學生招聘個案 <span class="accent">（學術）</span></h1>
            <p>幫助小學生與中學生找到專業導師，提升學習成就</p>
          </div>
        </div>

        <div class="toolbar">
          <button id="filterOpen" class="btn filter-btn">
            <span class="filter-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M4 5h16M7 11h10M10 17h4" stroke="#F8FAFC" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            篩選
          </button>

          <button id="subjectBtn" class="btn desktop-only">科目篩選</button>

          <button id="shuffle" class="btn">重新隨機</button>
          <button id="resetAll" class="btn">重設所有篩選</button>
        </div>
      </div>
    </div>

    <!-- 篩選 + 搜尋列 -->
    <section class="filter-row" aria-label="篩選與搜尋">
      <div class="filters" aria-label="篩選條件">
        <div class="field">
          <span class="label">上課及授課地區 / 網上授課</span>
          <select id="district">
            <option value="">全部地區</option>
            <option>網上授課</option>
            <option>中西區</option><option>灣仔區</option><option>東區</option><option>南區</option>
            <option>油尖旺區</option><option>深水埗區</option><option>九龍城區</option><option>黃大仙區</option><option>觀塘區</option>
            <option>葵青區</option><option>荃灣區</option><option>屯門區</option><option>元朗區</option><option>北區</option><option>大埔區</option>
            <option>沙田區</option><option>西貢區</option><option>離島區</option>
          </select>
        </div>

        <div class="field">
          <span class="label fee-label">價位區間（HK$/時）</span>

          <div class="slider-row">
            <div class="slider-col">
              <span class="mini">價位下限</span>
              <input id="feeMin" type="range" min="0" max="500" step="10" />
            </div>
            <div class="slider-col">
              <span class="mini">價位上限</span>
              <input id="feeMax" type="range" min="0" max="500" step="10" />
            </div>
          </div>
          <div class="label" id="feeLabel">HK$ 0 – 500</div>

          <select id="feeBand">
            <option value="">全部價位</option>
            <option value="0-100">HK$0–100/小時</option>
            <option value="100-200">HK$100–200/小時</option>
            <option value="200-300">HK$200–300/小時</option>
            <option value="300-400">HK$300–400/小時</option>
            <option value="400+">HK$400以上/小時</option>
          </select>
        </div>

        <div class="field">
          <span class="label">張貼日期排序</span>
          <select id="sortDate">
            <option value="desc">最近 → 最久</option>
            <option value="asc">最久 → 最近</option>
            <option value="rand">隨機時間排序</option>
          </select>
        </div>

        <div class="field">
          <span class="label">導師性別偏好</span>
          <select id="genderPref">
            <option value="">不限導師性別</option>
            <option value="male">學生偏好男導師</option>
            <option value="female">學生偏好女導師</option>
          </select>
        </div>
      </div>

      <div class="search-row" aria-label="搜尋">
        <div class="field">
          <span class="label">關鍵字搜尋</span>
          <input id="q" type="search" placeholder="姓名 / 年級 / 學科 / 備註…" />
        </div>

        <div class="field">
          <span class="label">案件編號搜尋</span>
          <input id="idq" type="text" placeholder="輸入案件編號（如：HK-202511-003）" />
        </div>
      </div>
    </section>

    <div id="activeBar" class="active-bar hidden" aria-live="polite"></div>

    <div class="meta" id="count">載入中…</div>

    <section id="grid" class="grid" aria-live="polite" aria-busy="true"></section>

    <div class="pager">
      <button id="prevPage" class="pagebtn">上一頁</button>
      <span id="pageInfo" class="pageinfo">第 1 / 1 頁</span>
      <button id="nextPage" class="pagebtn">下一頁</button>
    </div>
  </div>

  <!-- 完整個案 Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <header>
        <div class="title" style="gap:10px">
          <div id="modalAvatar" class="avatar" style="width:44px;height:44px"></div>
          <div>
            <h2 id="modalTitle" style="margin:0; font-size:20px"></h2>
            <div id="modalSub" class="who muted" style="margin-top:4px"></div>
          </div>
        </div>
        <a
          href="https://forms.gle/pXgGyQMeqcuSinKa7"
          target="_blank"
          rel="noopener noreferrer"
          class="apply-btn"
        >
          立即申請！
        </a>
        <button class="close" id="modalClose" aria-label="關閉">✕</button>
      </header>
      <div class="body">
        <div class="profile-grid">
          <div class="profile-card">
            <h3 class="profile-title">基本資料</h3>
            <div class="kv" id="kv-basic"></div>
            <div class="cta-row">
              <button id="copyId" class="copy">複製案件編號</button>
            </div>
          </div>
          <div class="profile-card">
            <h3 class="profile-title">課程期望</h3>
            <div class="kv" id="kv-expect"></div>
          </div>
          <div class="profile-card" style="grid-column:1/-1">
            <h3 class="profile-title">備註 / 目標</h3>
            <div id="kv-notes" style="white-space:pre-wrap; line-height:1.7; font-size:14px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 科目篩選 Modal -->
  <div id="subBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="subTitle">
      <header>
        <h2 id="subTitle" style="margin:0; font-size:20px; color:var(--accent)">科目篩選</h2>
        <button class="close" id="subClose" aria-label="關閉">✕</button>
      </header>
      <div class="body">
        <div class="field">
          <span class="label">考試總類 / 課程類別</span>
          <select id="fwSelect">
            <option value="DSE">DSE</option>
            <option value="IGCSE">IGCSE</option>
            <option value="A-Level">A-Level</option>
            <option value="IB">IB</option>
            <option value="小學">小學</option>
            <option value="初中">初中</option>
            <option value="幼稚園">幼稚園</option>
            <option value="其他類別">其他類別</option>
          </select>
        </div>
        <hr class="line">
        <div class="mini">勾選相應學科（可複選）；若不勾選直接「套用篩選」，將過濾整個類別</div>
        <div id="subList" class="subgrid"></div>
        <div class="bar">
          <button id="selAll" class="btn btn-accent">全選</button>
          <button id="clrThis" class="btn">清除此類別</button>
          <button id="clrAll" class="btn btn-accent">清除全部科目</button>
          <span id="selCount" class="mini fw">已選：0 科目</span>
        </div>
        <div class="bar" style="justify-content:flex-end; margin-top:12px">
          <button id="applySub" class="btn btn-accent">套用篩選</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 手機「篩選」底板 -->
  <div id="filterBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="filter-panel" role="document" aria-labelledby="filterTitle">
      <div class="filter-header">
        <h2 id="filterTitle" class="filter-title">篩選條件</h2>
        <div class="filter-header-right">
          <button id="filterApply" class="filter-apply-btn">套用篩選</button>
          <button id="filterClose" class="filter-close" aria-label="關閉">✕</button>
        </div>
      </div>
      <div class="filter-body" id="filterPanelBody">
        <div class="field mobile-subject-row">
          <span class="label">科目篩選</span>
          <button id="mobileSubjectBtn" class="btn" style="padding-inline:12px">開啟科目篩選</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const menuBtn = document.getElementById('menuBtn');
      const drawer  = document.getElementById('drawer');
      const overlay = document.getElementById('overlay');
      const closeBtn= document.getElementById('closeBtn');

      if(!menuBtn || !drawer || !overlay || !closeBtn) return;
      let lastFocus = null;

      function openNav(){
        lastFocus = document.activeElement;
        drawer.classList.add('open');
        overlay.classList.add('open');
        drawer.setAttribute('aria-hidden','false');
        overlay.setAttribute('aria-hidden','false');
        menuBtn.setAttribute('aria-expanded','true');
        closeBtn.focus({ preventScroll:true });
      }

      function closeNav(){
        drawer.classList.remove('open');
        overlay.classList.remove('open');
        drawer.setAttribute('aria-hidden','true');
        overlay.setAttribute('aria-hidden','true');
        menuBtn.setAttribute('aria-expanded','false');
        if(lastFocus && typeof lastFocus.focus === 'function'){
          lastFocus.focus({ preventScroll:true });
        }else{
          menuBtn.focus({ preventScroll:true });
        }
      }

      menuBtn.addEventListener('click', () => {
        const isOpen = drawer.classList.contains('open');
        if(isOpen) closeNav(); else openNav();
      });

      closeBtn.addEventListener('click', closeNav);
      overlay.addEventListener('click', closeNav);

      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && drawer.classList.contains('open')){
          closeNav();
        }
      });

      drawer.addEventListener('click', (e)=>{
        const a = e.target.closest('a');
        if(a) closeNav();
      });
    })();

    /* ===== 科目清單 ===== */
    const SUBJECTS = {
      "DSE": [
        "中文","英文","數學（必修部分）","公民與社會發展科","物理","化學","生物","經濟",
        "企業，會計，與財務概論","歷史","中史","地理","中國文學","資訊及通訊科技",
        "視覺藝術","音樂","體育","倫理與宗教","M1（微積分及統計）","M2（微積分及代數）"
      ],
      "IGCSE": [
        "English Language","English Literature","Mathematics – Core","Further Mathematics",
        "Biology","Chemistry","Physics","History","Geography","Economics","Global Perspectives",
        "Sociology","French – Foreign Language","Spanish – Foreign Language","Arabic – First Language",
        "Chinese – First Language","German – Foreign Language","Art and Design","Business Studies",
        "Information and Communication Technology (ICT)","Computer Science","Drama","Music"
      ],
      "A-Level": [
        "Art and Design","Biology","Business","Chemistry","Chinese","Economics",
        "English Language","English Literature","Further Mathematics","Geography",
        "History","Mathematics","Physics","Psychology"
      ],
      "IB": [
        "Language A: literature","Language A: language and literature","Language B","Business management",
        "Digital society","Economics","Geography","History","Psychology","Biology","Chemistry",
        "Computer science","Design technology","Physics","Sports, exercise and health science",
        "Mathematics - Analysis and approaches","Mathematics - Applications and interpretation","Theory of knowledge"
      ],
      "小學": [
        "中文","英文","數學","常識","普通話","STEM/科學","寫作","閱讀理解","音樂","視覺藝術","體育","電腦/資訊科技"
      ],
      "初中": [
        "中文","英文","數學","科技與生活","綜合科學","初中化學","初中生物","初中物理",
        "初中商學","初中歷史","初中中史","電腦及資訊科技","初中地理","家政","視覺藝術",
        "音樂","普通話"
      ],
      "幼稚園": [
        "中文（語文啟蒙）","英文（Phonics）","數學前概念","常識與探索","專注力/精細動作","普通話","音樂與律動","創意美術"
      ],
      "其他類別": [
        "微積分","統計學","編程（Python）","編程（JavaScript）","資料科學入門",
        "寫作技巧","演講與辯論","面試技巧","商業入門","設計（平面/Canva）",
        "IELTS","TOEFL","PTE","其他分類"
      ]
    };

    /* ===== 參考個案 ===== */
    const CASES = [
      { id:"HK-202511-001", name:"王同學", grade:"中三", level:"DSE",
        subjectsDisplay:["數學（必修部分）","化學"], tags:["DSE:數學（必修部分）","DSE:化學"],
        district:"沙田區", fee:220, weeklyLessons:2, lessonLength:1.5,
        notes:"DSE 長期規劃，先補強代數與幾何證明。\n近三次校內測驗約 60 分上下。",
        startDate:"可即時開始", schedule:"平日 19:00 後、週末下午",
        tutorGenderPref:"male" },
      { id:"HK-202511-002", name:"陳同學", grade:"小五", level:"小學",
        subjectsDisplay:["英文"], tags:["小學:英文"],
        district:"網上授課", fee:180, weeklyLessons:3, lessonLength:1,
        notes:"自然拼讀薄弱，想加強朗讀流暢度與拼寫規則。",
        startDate:"12 月可開始", schedule:"一三五 18:30",
        tutorGenderPref:"female" },
      { id:"HK-202511-003", name:"林同學", grade:"中五", level:"DSE",
        subjectsDisplay:["化學","生物"], tags:["DSE:化學","DSE:生物"],
        district:"觀塘區", fee:260, weeklyLessons:2, lessonLength:2,
        notes:"衝刺 DSE，實驗題與數據處理題型較弱。",
        startDate:"可議", schedule:"週末全天",
        tutorGenderPref:"" },
      { id:"HK-202511-004", name:"張同學", grade:"大一", level:"其他類別",
        subjectsDisplay:["微積分"], tags:["其他類別:微積分"],
        district:"油尖旺區", fee:300, weeklyLessons:1, lessonLength:2,
        notes:"極限、微分應用與 L'Hôpital 用法需要系統複盤。",
        startDate:"即日起", schedule:"可議",
        tutorGenderPref:"male" },
      { id:"HK-202511-005", name:"何同學", grade:"小三", level:"小學",
        subjectsDisplay:["數學","常識"], tags:["小學:數學","小學:常識"],
        district:"九龍城區", fee:170, weeklyLessons:2, lessonLength:1,
        notes:"建立解題步驟與心算能力，樂於互動式學習。",
        startDate:"12/01 後", schedule:"二四 17:30",
        tutorGenderPref:"" },
      { id:"HK-202511-006", name:"Tracy", grade:"Year 11", level:"IGCSE",
        subjectsDisplay:["English Language","Biology"], tags:["IGCSE:English Language","IGCSE:Biology"],
        district:"中西區", fee:260, weeklyLessons:2, lessonLength:1.5,
        notes:"Mock 測前加強寫作與生物圖表題。",
        startDate:"12/10", schedule:"二四晚",
        tutorGenderPref:"female" },
      { id:"HK-202511-007", name:"Jason", grade:"Year 13", level:"A-Level",
        subjectsDisplay:["Mathematics","Physics"], tags:["A-Level:Mathematics","A-Level:Physics"],
        district:"荃灣區", fee:320, weeklyLessons:2, lessonLength:2,
        notes:"A2 衝刺，力學/向量題偏弱。",
        startDate:"即時", schedule:"週末下午",
        tutorGenderPref:"" },
      { id:"HK-202511-008", name:"Iris", grade:"IB DP2", level:"IB",
        subjectsDisplay:["Mathematics - Analysis and approaches","Chemistry"],
        tags:["IB:Mathematics - Analysis and approaches","IB:Chemistry"],
        district:"灣仔區", fee:350, weeklyLessons:1, lessonLength:2,
        notes:"IA 輔導與考前重點複習。",
        startDate:"12 月", schedule:"可議",
        tutorGenderPref:"female" },
      { id:"HK-202511-009", name:"Kathy", grade:"K2", level:"幼稚園",
        subjectsDisplay:["英文（Phonics）","普通話"], tags:["幼稚園:英文（Phonics）","幼稚園:普通話"],
        district:"離島區", fee:200, weeklyLessons:2, lessonLength:1,
        notes:"專注力稍弱，想以遊戲式提升語音覺識與聽說。",
        startDate:"12 月中", schedule:"三五 16:30",
        tutorGenderPref:"" },
      { id:"HK-202511-010", name:"黃同學", grade:"中六", level:"DSE",
        subjectsDisplay:["中文","公民與社會發展科"], tags:["DSE:中文","DSE:公民與社會發展科"],
        district:"屯門區", fee:230, weeklyLessons:2, lessonLength:1.5,
        notes:"卷一閱讀需提升，CSD SBA 討論與資料整理。",
        startDate:"可議", schedule:"平日晚上",
        tutorGenderPref:"male" },

      { id:"HK-202511-011", name:"劉同學", grade:"中四", level:"DSE",
        subjectsDisplay:["英文","物理"], tags:["DSE:英文","DSE:物理"],
        district:"西貢區", fee:240, weeklyLessons:2, lessonLength:1.5,
        notes:"閱讀理解與電學題型需要加強，目標由 4 升至 5**。",
        startDate:"可議", schedule:"二四 19:00",
        tutorGenderPref:"" },
      { id:"HK-202511-012", name:"Bonnie", grade:"Year 10", level:"IGCSE",
        subjectsDisplay:["Computer Science","Mathematics – Core"], tags:["IGCSE:Computer Science","IGCSE:Mathematics – Core"],
        district:"網上授課", fee:270, weeklyLessons:2, lessonLength:1.5,
        notes:"Python 基礎與時間複雜度觀念薄弱，需要每週練習題。",
        startDate:"12/05", schedule:"一三晚",
        tutorGenderPref:"female" },
      { id:"HK-202511-013", name:"陳同學", grade:"中二", level:"DSE",
        subjectsDisplay:["數學（必修部分）"], tags:["DSE:數學（必修部分）"],
        district:"北區", fee:190, weeklyLessons:2, lessonLength:1.5,
        notes:"想建立代數與比例的扎實基礎，之後銜接 M1。",
        startDate:"12 月", schedule:"週末上午",
        tutorGenderPref:"" },
      { id:"HK-202511-014", name:"Marco", grade:"IB DP1", level:"IB",
        subjectsDisplay:["Physics","Theory of knowledge"], tags:["IB:Physics","IB:Theory of knowledge"],
        district:"葵青區", fee:360, weeklyLessons:2, lessonLength:1.5,
        notes:"IA 題目討論與 TOK Essay 框架指導。",
        startDate:"可議", schedule:"三 18:30",
        tutorGenderPref:"male" },
      { id:"HK-202511-015", name:"Grace", grade:"Year 12", level:"A-Level",
        subjectsDisplay:["Psychology","Economics"], tags:["A-Level:Psychology","A-Level:Economics"],
        district:"觀塘區", fee:330, weeklyLessons:2, lessonLength:2,
        notes:"評分標準與答題結構練習，強化 AO2/AO3。",
        startDate:"即時", schedule:"二四 20:00",
        tutorGenderPref:"" },
      { id:"HK-202511-016", name:"張同學", grade:"小六", level:"小學",
        subjectsDisplay:["中文","寫作"], tags:["小學:中文","小學:寫作"],
        district:"元朗區", fee:180, weeklyLessons:2, lessonLength:1,
        notes:"敘事文段落組織與用詞累積，準備升中面試。",
        startDate:"12/08", schedule:"一三 17:00",
        tutorGenderPref:"female" },
      { id:"HK-202511-017", name:"Ivy", grade:"K3", level:"幼稚園",
        subjectsDisplay:["音樂與律動","中文（語文啟蒙）"], tags:["幼稚園:音樂與律動","幼稚園:中文（語文啟蒙）"],
        district:"深水埗區", fee:190, weeklyLessons:2, lessonLength:1,
        notes:"藉由律動提升專注與語音覺識（押韻/分音）。",
        startDate:"可議", schedule:"四 16:00",
        tutorGenderPref:"" },
      { id:"HK-202511-018", name:"Ryan", grade:"大二", level:"其他類別",
        subjectsDisplay:["資料科學入門","編程（Python）"], tags:["其他類別:資料科學入門","其他類別:編程（Python）"],
        district:"中西區", fee:320, weeklyLessons:1, lessonLength:2,
        notes:"Numpy/Pandas、基礎 EDA 與 Matplotlib 繪圖。",
        startDate:"即時", schedule:"六 下午",
        tutorGenderPref:"male" },
      { id:"HK-202511-019", name:"鄭同學", grade:"中六", level:"DSE",
        subjectsDisplay:["經濟","中國文學"], tags:["DSE:經濟","DSE:中國文學"],
        district:"黃大仙區", fee:250, weeklyLessons:2, lessonLength:1.5,
        notes:"經濟圖像題速解與中學文答題技巧（引證/評析）。",
        startDate:"12 月中", schedule:"一三五 晚上",
        tutorGenderPref:"female" },
      { id:"HK-202511-020", name:"Leo", grade:"Year 12", level:"A-Level",
        subjectsDisplay:["Further Mathematics","Chemistry"], tags:["A-Level:Further Mathematics","A-Level:Chemistry"],
        district:"網上授課", fee:340, weeklyLessons:2, lessonLength:2,
        notes:"FP/ME 選修題突破與化學計算題速度訓練。",
        startDate:"可議", schedule:"二四 晚間",
        tutorGenderPref:"" }
    ];

    /* ===== 工具函式 ===== */
    function shuffle(arr){ const a=arr.slice(); for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]];} return a; }
    function esc(str){
      return String(str ?? "").replace(/[&<>"'`=\/]/g, s => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
      }[s]));
    }
    function colorFromName(name){ let h=0; for(let i=0;i<name.length;i++){ h=(h*31 + name.charCodeAt(i))%360; } return `hsl(${h} 70% 50%)`; }
    function scrollToTop(){ try{ window.scrollTo({top:0,behavior:'smooth'});}catch{ window.scrollTo(0,0);} }

    function parseISODate(s){
      const m = String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if(!m) return null;
      const y=+m[1], mm=+m[2]-1, d=+m[3];
      const dt = new Date(Date.UTC(y,mm,d));
      return isNaN(dt)? null : dt;
    }
    function deriveDateFromId(id){
      const m = String(id||'').match(/-(\d{4})(\d{2})-(\d{3})$/);
      if(!m) return null;
      const y = +m[1], mm = +m[2]-1, seq = +m[3];
      const day = (seq % 28) + 1;
      const dt = new Date(Date.UTC(y, mm, day));
      return isNaN(dt)? null : dt;
    }
    function tsOf(c){
      const d = c.postedDate ? parseISODate(c.postedDate) : deriveDateFromId(c.id);
      return d ? d.getTime() : 0;
    }
    function fmtDate(ts){
      if(!ts) return "—";
      const d = new Date(ts);
      const y=d.getUTCFullYear(), m=String(d.getUTCMonth()+1).padStart(2,'0'), dd=String(d.getUTCDate()).padStart(2,'0');
      return `${y}/${m}/${dd}`;
    }

    async function copyTextFallback(text){
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.setAttribute('readonly','');
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.select();
      let ok = false;
      try { ok = document.execCommand('copy'); } catch(e) { ok = false; }
      document.body.removeChild(ta);
      return ok;
    }
    async function copyToClipboard(text){
      try{
        if (navigator.clipboard && window.isSecureContext){
          await navigator.clipboard.writeText(text);
          return true;
        }
      }catch(e){}
      return await copyTextFallback(text);
    }

    /* ===== range fill helper (webkit) ===== */
    function setRangePct(el){
      const min = Number(el.min || 0);
      const max = Number(el.max || 100);
      const v = Number(el.value || 0);
      const pct = max === min ? 0 : ((v - min) / (max - min)) * 100;
      el.style.setProperty('--pct', `${pct}%`);
    }

    /* ===== DOM 參照 ===== */
    const grid = document.getElementById('grid');
    const countEl = document.getElementById('count');
    const q = document.getElementById('q');
    const idq = document.getElementById('idq');
    const districtSel = document.getElementById('district');
    const feeMin = document.getElementById('feeMin');
    const feeMax = document.getElementById('feeMax');
    const feeLabel = document.getElementById('feeLabel');
    const feeBand = document.getElementById('feeBand');
    const genderPrefSel = document.getElementById('genderPref');
    const activeBar = document.getElementById('activeBar');
    const sortDateSel = document.getElementById('sortDate');

    const backdrop = document.getElementById('backdrop');
    const modalClose = document.getElementById('modalClose');
    const modalAvatar = document.getElementById('modalAvatar');
    const modalTitle = document.getElementById('modalTitle');
    const modalSub = document.getElementById('modalSub');
    const kvBasic = document.getElementById('kv-basic');
    const kvExpect = document.getElementById('kv-expect');
    const kvNotes = document.getElementById('kv-notes');
    const copyIdBtn = document.getElementById('copyId');

    const subjectBtn = document.getElementById('subjectBtn');
    const subBackdrop = document.getElementById('subBackdrop');
    const subClose = document.getElementById('subClose');
    const fwSelect = document.getElementById('fwSelect');
    const subList = document.getElementById('subList');
    const selAll = document.getElementById('selAll');
    const clrThis = document.getElementById('clrThis');
    const clrAll = document.getElementById('clrAll');
    const selCount = document.getElementById('selCount');
    const applySub = document.getElementById('applySub');

    const PAGE_SIZE = 9;
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const pageInfo = document.getElementById('pageInfo');

    /* 手機「篩選」底板元素 */
    const filterBackdrop = document.getElementById('filterBackdrop');
    const filterOpenBtn = document.getElementById('filterOpen');
    const filterCloseBtn = document.getElementById('filterClose');
    const filterApplyBtn = document.getElementById('filterApply');
    const filterPanelBody = document.getElementById('filterPanelBody');
    const mobileSubjectBtn = document.getElementById('mobileSubjectBtn');
    const filtersSection = document.querySelector('.filters');
    const mobileSubjectRow = document.querySelector('.mobile-subject-row');
    const filtersHomeParent = filtersSection.parentNode;
    const filtersHomeNextSibling = filtersSection.nextElementSibling;

    /* 狀態 */
    let currentPage = 1;
    let data = CASES.slice();
    data.forEach(c=>{ c._ts = tsOf(c); c._dateStr = fmtDate(c._ts); });
    let view = data.slice();

    const subjectsSelected = {
      "DSE": new Set(),
      "IGCSE": new Set(),
      "A-Level": new Set(),
      "IB": new Set(),
      "小學": new Set(),
      "初中": new Set(),
      "幼稚園": new Set(),
      "其他類別": new Set()
    };
    const selectedCategories = new Set();

    let filtersInSheet = false;
    let subjectOpenedFromFilterSheet = false;

    /* ✅ NEW: staging snapshot for mobile filter sheet (no apply = no effect + auto revert) */
    let sheetSnapshot = null;
    let closingByApply = false;

    function snapshotSubjectState(){
      const subj = {};
      for(const k of Object.keys(subjectsSelected)){
        subj[k] = Array.from(subjectsSelected[k]);
      }
      return {
        subjects: subj,
        cats: Array.from(selectedCategories)
      };
    }
    function restoreSubjectState(state){
      for(const k of Object.keys(subjectsSelected)){
        subjectsSelected[k].clear();
        (state.subjects?.[k] || []).forEach(v=>subjectsSelected[k].add(v));
      }
      selectedCategories.clear();
      (state.cats || []).forEach(v=>selectedCategories.add(v));
    }

    function snapshotFilters(){
      return {
        district: districtSel.value,
        feeMin: feeMin.value,
        feeMax: feeMax.value,
        feeBand: feeBand.value,
        genderPref: genderPrefSel.value,
        sortDate: sortDateSel.value,
        subjectState: snapshotSubjectState()
      };
    }
    function restoreFilters(snap){
      if(!snap) return;
      districtSel.value = snap.district;
      feeMin.value = snap.feeMin;
      feeMax.value = snap.feeMax;
      feeBand.value = snap.feeBand;
      genderPrefSel.value = snap.genderPref;
      sortDateSel.value = snap.sortDate;
      restoreSubjectState(snap.subjectState);

      // update fee label + range fill
      setRangePct(feeMin); setRangePct(feeMax);
      const min = Number(feeMin.value), max = Number(feeMax.value);
      feeLabel.textContent = `HK$ ${Math.min(min,max)} – ${Math.max(min,max)}`;
    }

    /* ===== 價位 slider ===== */
    function initFees(){
      const fees = data.map(x=>x.fee).filter(x=>typeof x==='number');
      const min = Math.min(...fees, 0);
      const max = Math.max(...fees, 500);
      const lo = Math.floor(min/10)*10;
      const hi = Math.ceil(max/10)*10;
      feeMin.min = feeMax.min = String(lo);
      feeMin.max = feeMax.max = String(hi);
      feeMin.value = String(lo);
      feeMax.value = String(hi);
      feeLabel.textContent = `HK$ ${feeMin.value} – ${feeMax.value}`;
      feeBand.value = "";
      setRangePct(feeMin); setRangePct(feeMax);
    }

    /* ===== 科目篩選面板 ===== */
    function updateSelCount(){
      const fw = fwSelect.value;
      selCount.textContent = `已選：${subjectsSelected[fw].size} 科目`;
    }
    function renderSubList(){
      const fw = fwSelect.value;
      subList.innerHTML = '';
      (SUBJECTS[fw] || []).forEach((s, i)=>{
        const id = `sub-${fw}-${i}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" id="${id}"> <span>${esc(s)}</span>`;
        const input = label.querySelector('input');
        input.checked = subjectsSelected[fw].has(s);
        input.addEventListener('change', ()=>{
          if(input.checked) {
            subjectsSelected[fw].add(s);
            selectedCategories.delete(fw);
          } else {
            subjectsSelected[fw].delete(s);
          }
          updateSelCount();
        });
        subList.appendChild(label);
      });
      updateSelCount();
    }
    function openSubModal(){
      subBackdrop.classList.add('show');
      subBackdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      renderSubList();
      subClose.focus();
    }
    function closeSubModal(){
      subjectOpenedFromFilterSheet = false;
      subBackdrop.classList.remove('show');
      subBackdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }

    fwSelect.addEventListener('change', renderSubList);
    selAll.addEventListener('click', ()=>{
      const fw = fwSelect.value;
      subjectsSelected[fw] = new Set(SUBJECTS[fw]);
      selectedCategories.delete(fw);
      renderSubList();
    });
    clrThis.addEventListener('click', ()=>{
      const fw = fwSelect.value;
      subjectsSelected[fw].clear();
      selectedCategories.delete(fw);
      renderSubList();
    });
    clrAll.addEventListener('click', ()=>{
      for(const k of Object.keys(subjectsSelected)){ subjectsSelected[k].clear(); }
      selectedCategories.clear();
      renderSubList();
    });

    // 手機：科目「套用篩選」不立即刷新主頁；回到篩選面板，等「套用篩選」才生效
    applySub.addEventListener('click', ()=>{
      const fw = fwSelect.value;
      if(subjectsSelected[fw].size === 0) selectedCategories.add(fw);
      else selectedCategories.delete(fw);

      const fromSheet = subjectOpenedFromFilterSheet || window.innerWidth <= 560;

      if(fromSheet){
        closeSubModal();
        if(window.innerWidth <= 560){
          openFilterSheet(); // 回篩選底板（暫不刷新）
        }
      }else{
        currentPage = 1;
        refresh();
        closeSubModal();
      }
    });

    if(subjectBtn){
      subjectBtn.addEventListener('click', ()=>{
        subjectOpenedFromFilterSheet = false;
        openSubModal();
      });
    }
    subClose.addEventListener('click', closeSubModal);
    subBackdrop.addEventListener('click', (e)=>{ if(e.target === subBackdrop) closeSubModal(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && subBackdrop.classList.contains('show')) closeSubModal(); });

    /* ===== 篩選條件 ===== */
    function passesFee(c){
      const fee = Number(c.fee ?? 0);
      const band = feeBand.value;

      if(band){
        if(band === "0-100")   return fee >= 0   && fee <= 100;
        if(band === "100-200") return fee >= 100 && fee <= 200;
        if(band === "200-300") return fee >= 200 && fee <= 300;
        if(band === "300-400") return fee >= 300 && fee <= 400;
        if(band === "400+")    return fee > 400;
      }

      let min = Number(feeMin.value), max = Number(feeMax.value);
      if(min > max){ [min, max] = [max, min]; feeMin.value = String(min); feeMax.value = String(max); }
      feeLabel.textContent = `HK$ ${min} – ${max}`;
      return fee >= min && fee <= max;
    }

    function passesDistrict(c){
      const d = districtSel.value;
      if(!d) return true;
      return c.district === d;
    }

    function passesSubjects(c){
      const anySubjects = Object.values(subjectsSelected).some(set=>set.size>0);
      const anyCats = selectedCategories.size > 0;
      if(!anySubjects && !anyCats) return true;

      if(anyCats && selectedCategories.has(c.level)) return true;

      if(anySubjects){
        if(!Array.isArray(c.tags) || c.tags.length===0) return false;
        for(const [fw,set] of Object.entries(subjectsSelected)){
          for(const sub of set){
            if(c.tags.includes(`${fw}:${sub}`)) return true;
          }
        }
      }
      return false;
    }

    function passesGender(c){
      const g = genderPrefSel.value;
      if(!g) return true;
      const pref = c.tutorGenderPref || "";
      if(g === "male")   return pref === "male"   || pref === "";
      if(g === "female") return pref === "female" || pref === "";
      return true;
    }

    function passesKeyword(c){
      const k = q.value.trim().toLowerCase();
      if(!k) return true;
      const hay = [
        c.id, c.name, c.grade, c.level, c.district, c.notes, c.schedule, c.startDate,
        (c.fee??"")+"", (c.weeklyLessons??"")+"", (c.lessonLength??"")+"",
        ...(c.subjectsDisplay||[])
      ].join(' ').toLowerCase();
      return hay.includes(k);
    }

    function passesId(c){
      const s = idq.value.trim();
      if(!s) return true;
      return (c.id||'').toLowerCase().includes(s.toLowerCase());
    }

    function applyFilters(){
      return data.filter(c =>
        passesFee(c) &&
        passesDistrict(c) &&
        passesSubjects(c) &&
        passesGender(c) &&
        passesKeyword(c) &&
        passesId(c)
      );
    }

    /* ===== 排序 ===== */
    function sortByPosted(arr){
      const mode = sortDateSel.value;
      if(mode === 'rand') return shuffle(arr);
      return arr.slice().sort((a,b)=>{
        const ta=a._ts||0, tb=b._ts||0;
        return mode === 'asc' ? (ta - tb) : (tb - ta);
      });
    }

    /* ===== 已啟用科目/類別標籤列 ===== */
    function renderActiveBar(){
      const chips = [];
      selectedCategories.forEach(fw=>{
        chips.push({type:'cat', fw, label:`${fw}（整類）`});
      });
      for(const [fw,set] of Object.entries(subjectsSelected)){
        set.forEach(sub=>{
          chips.push({type:'sub', fw, sub, label:`${fw}: ${sub}`});
        });
      }

      if(chips.length === 0){
        activeBar.classList.add('hidden');
        activeBar.innerHTML = '';
        return;
      }

      activeBar.classList.remove('hidden');
      activeBar.innerHTML = `<span class="mini">科目 / 類別：</span>`;
      for(const c of chips){
        const chip = document.createElement('span');
        chip.className = 'chip';
        chip.innerHTML = `
          <button class="x" title="移除此篩選" data-type="${c.type}" data-fw="${esc(c.fw)}" ${c.sub?`data-sub="${esc(c.sub)}"`:''}>×</button>
          <span>${esc(c.label)}</span>
        `;
        activeBar.appendChild(chip);
      }
    }

    activeBar.addEventListener('click', (e)=>{
      const btn = e.target.closest('button.x');
      if(!btn) return;
      const type = btn.getAttribute('data-type');
      const fw = btn.getAttribute('data-fw');
      const sub = btn.getAttribute('data-sub');

      if(type === 'cat'){
        selectedCategories.delete(fw);
      }else if(type === 'sub'){
        if(subjectsSelected[fw]) subjectsSelected[fw].delete(sub);
      }
      currentPage = 1;
      refresh();
    });

    /* ===== 渲染列表 ===== */
    function renderList(){
      grid.setAttribute('aria-busy','true');
      grid.innerHTML = '';

      const total = view.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      currentPage = Math.min(Math.max(1, currentPage), totalPages);

      const start = (currentPage - 1) * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);
      const pageSlice = view.slice(start, end);

      if(pageSlice.length === 0){
        const empty = document.createElement('div');
        empty.className = 'empty';
        empty.textContent = '找不到符合條件的案例。請調整篩選或清除搜尋。';
        grid.appendChild(empty);
      } else {
        for(const c of pageSlice){
          const card = document.createElement('article');
          card.className = 'card';
          card.tabIndex = 0;
          const initials = esc((c.name||'?').slice(0,2));
          const avatarColor = colorFromName(c.name||'');

          card.innerHTML = `
            <div class="top">
              <div class="avatar" style="background:${avatarColor};" aria-hidden="true">${initials}</div>
              <div class="who">
                <div class="name">${esc(c.name)}　<small style="color:var(--muted)">${esc(c.grade || '')}</small></div>
                <div class="muted">案件編號：${esc(c.id || '-') }</div>
              </div>
            </div>

            <div class="row">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M3 11h18M6 7h12M6 15h12M5 21l2-6m10 6l2-6" stroke="var(--accent)" stroke-width="1.4" stroke-linecap="round"/></svg>
              <span>${esc((c.subjectsDisplay||[]).join('、') || '—')}</span>
            </div>

            <div class="row">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M12 20s8-4.5 8-11a8 8 0 1 0-16 0c0 6.5 8 11 8 11Z" stroke="var(--accent)" stroke-width="1.4"/><circle cx="12" cy="9" r="2" fill="var(--accent)"/></svg>
              <span>${esc(c.district || '—')}</span>
            </div>

            <div class="row" title="每週堂數 × 每堂時數">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M7 3h10v4H7zM4 7h16v14H4z" stroke="var(--accent)" stroke-width="1.4"/></svg>
              <span>${esc(c.weeklyLessons ?? '—')} 堂／週　·　${esc(c.lessonLength ?? '—')} 小時／堂</span>
            </div>

            <div class="tags">
              <span class="tag">考試類別：${esc(c.level || '—')}</span>
              <span class="tag">學費：HK$ ${esc(c.fee ?? '—')}/時</span>
              <span class="tag">張貼：${esc(c._dateStr || '—')}</span>
              ${c.schedule ? `<span class="tag">${esc(c.schedule)}</span>`:''}
              ${c.startDate ? `<span class="tag">開始：${esc(c.startDate)}</span>`:''}
            </div>

            ${c.notes ? `<p class="note">${esc(c.notes)}</p>`:''}

            <div class="foot">
              <span>點擊查看完整個案</span>
              <span class="budget">${(c.fee || c.fee===0) ? `HK$ ${esc(c.fee)}/時` : '面議'}</span>
            </div>
          `;
          card.addEventListener('click', ()=> openProfile(c));
          card.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); openProfile(c); }});
          grid.appendChild(card);
        }
      }

      const shownFrom = total === 0 ? 0 : (start + 1);
      const shownTo = end;
      countEl.textContent = `符合 ${total} 個招聘個案　·　顯示第 ${shownFrom}–${shownTo} 個招聘個案`;

      pageInfo.textContent = `第 ${currentPage} / ${Math.max(1, Math.ceil(total / PAGE_SIZE))} 頁`;
      grid.removeAttribute('aria-busy');
    }

    function refresh(){
      view = applyFilters();
      view = sortByPosted(view);
      renderList();
      renderActiveBar();
    }

    /* ===== 個案 Modal ===== */
    let openedCase = null;
    function openProfile(c){
      openedCase = c;
      modalAvatar.style.background = colorFromName(c.name||'?');
      modalAvatar.textContent = (c.name||'?').slice(0,2);
      modalTitle.textContent = `${c.name ?? '—'}（${c.grade ?? '—'}）`;
      modalSub.textContent = `案件編號：${c.id ?? '—'}`;

      kvBasic.innerHTML = `
        <b>就讀年級</b><div>${esc(c.grade ?? '—')}</div>
        <b>考試類別</b><div>${esc(c.level ?? '—')}</div>
        <b>學科</b><div>${esc((c.subjectsDisplay||[]).join('、') || '—')}</div>
        <b>期望上課地區</b><div>${esc(c.district ?? '—')}</div>
        <b>張貼日期</b><div>${esc(c._dateStr || '—')}</div>
      `;
      kvExpect.innerHTML = `
        <b>期望學費</b><div>HK$ ${esc(c.fee ?? '—')} / 小時</div>
        <b>每週堂數</b><div>${esc(c.weeklyLessons ?? '—')} 堂 / 週</div>
        <b>每堂時數</b><div>${esc(c.lessonLength ?? '—')} 小時 / 堂</div>
        <b>可開始日期</b><div>${esc(c.startDate ?? '—')}</div>
        <b>時段偏好</b><div>${esc(c.schedule ?? '—')}</div>
      `;
      kvNotes.textContent = c.notes || '—';

      copyIdBtn.textContent = '複製案件編號';

      backdrop.classList.add('show');
      backdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
      modalClose.focus();
    }
    function closeProfile(){
      openedCase = null;
      backdrop.classList.remove('show');
      backdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
    modalClose.addEventListener('click', closeProfile);
    backdrop.addEventListener('click', (e)=>{ if(e.target === backdrop) closeProfile(); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && backdrop.classList.contains('show')) closeProfile(); });

    copyIdBtn.addEventListener('click', async ()=>{
      if(!openedCase) return;
      const text = openedCase.id || '';
      const ok = await copyToClipboard(text);
      copyIdBtn.textContent = ok ? '已複製！' : '複製失敗，請手動';
    });

    /* ===== 手機「篩選」底板 ===== */
    function moveFiltersToSheet(){
      if(filtersInSheet) return;
      filterPanelBody.insertBefore(filtersSection, mobileSubjectRow);
      filtersInSheet = true;
    }
    function restoreFiltersHome(){
      if(!filtersInSheet) return;
      if(filtersHomeNextSibling && filtersHomeNextSibling.parentNode === filtersHomeParent){
        filtersHomeParent.insertBefore(filtersSection, filtersHomeNextSibling);
      } else {
        filtersHomeParent.appendChild(filtersSection);
      }
      filtersInSheet = false;
    }
    function openFilterSheet(){
      if(window.innerWidth > 560) return;
      // ✅ snapshot at open (so closing without apply reverts)
      sheetSnapshot = snapshotFilters();
      closingByApply = false;

      moveFiltersToSheet();
      filterBackdrop.classList.add('show');
      filterBackdrop.setAttribute('aria-hidden','false');
      document.body.style.overflow = 'hidden';
    }
    function closeFilterSheet(){
      if(window.innerWidth > 560){
        restoreFiltersHome();
      }

      // ✅ if NOT applying, revert everything (including subject selections)
      if(!closingByApply && sheetSnapshot){
        restoreFilters(sheetSnapshot);
      }

      filterBackdrop.classList.remove('show');
      filterBackdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
      closingByApply = false;
    }

    if(filterOpenBtn){
      filterOpenBtn.addEventListener('click', openFilterSheet);
    }
    if(filterCloseBtn){
      filterCloseBtn.addEventListener('click', closeFilterSheet);
    }
    if(filterApplyBtn){
      filterApplyBtn.addEventListener('click', ()=>{
        closingByApply = true;
        currentPage = 1;
        refresh();          // ✅ only here applies to main
        closeFilterSheet();
      });
    }
    if(filterBackdrop){
      filterBackdrop.addEventListener('click', (e)=>{
        if(e.target === filterBackdrop) closeFilterSheet();
      });
    }
    if(mobileSubjectBtn){
      mobileSubjectBtn.addEventListener('click', ()=>{
        subjectOpenedFromFilterSheet = true;
        closeFilterSheet();   // 先關閉底板（如未按套用，會回復 snapshot；但我們要保留本次編輯）
        // ✅ override: when opening subject from sheet, keep current edits (do not revert)
        closingByApply = true; // treat as intentional navigation, not cancel
        openSubModal();
      });
    }

    window.addEventListener('resize', ()=>{
      if(window.innerWidth > 560 && filtersInSheet){
        restoreFiltersHome();
        filterBackdrop.classList.remove('show');
        filterBackdrop.setAttribute('aria-hidden','true');
        document.body.style.overflow = '';
      }
    });

    /* ===== 一般事件綁定 ===== */
    document.getElementById('shuffle').addEventListener('click', ()=>{
      sortDateSel.value = 'rand';
      currentPage = 1;
      refresh();
    });

    document.getElementById('resetAll').addEventListener('click', ()=>{
      q.value = ''; idq.value = ''; districtSel.value = '';
      genderPrefSel.value = '';
      for(const k of Object.keys(subjectsSelected)){ subjectsSelected[k].clear(); }
      selectedCategories.clear();
      sortDateSel.value = 'desc';
      initFees();
      currentPage = 1;
      refresh();
    });

    // ✅ IMPORTANT: when mobile filter sheet is open, changes should NOT apply immediately.
    function canAutoRefresh(){
      return !(window.innerWidth <= 560 && filterBackdrop.classList.contains('show'));
    }

    q.addEventListener('input', ()=>{ currentPage=1; refresh(); });
    idq.addEventListener('input', ()=>{ currentPage=1; refresh(); });

    districtSel.addEventListener('change', ()=>{ if(canAutoRefresh()){ currentPage=1; refresh(); } });
    feeMin.addEventListener('input', ()=>{ setRangePct(feeMin); if(canAutoRefresh()){ currentPage=1; refresh(); } });
    feeMax.addEventListener('input', ()=>{ setRangePct(feeMax); if(canAutoRefresh()){ currentPage=1; refresh(); } });
    feeBand.addEventListener('change', ()=>{ if(canAutoRefresh()){ currentPage=1; refresh(); } });
    genderPrefSel.addEventListener('change', ()=>{ if(canAutoRefresh()){ currentPage=1; refresh(); } });
    sortDateSel.addEventListener('change', ()=>{ if(canAutoRefresh()){ currentPage=1; refresh(); } });

    prevPageBtn.addEventListener('click', ()=>{
      if(currentPage>1){
        currentPage--;
        renderList();
      }
    });
    nextPageBtn.addEventListener('click', ()=>{
      const totalPages = Math.max(1, Math.ceil(view.length / PAGE_SIZE));
      if(currentPage < totalPages){
        currentPage++;
        renderList();
        scrollToTop();
      }
    });

    /* ===== 啟動 ===== */
    function boot(){
      data = shuffle(data);
      initFees();
      renderSubList();
      sortDateSel.value = 'desc';
      refresh();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
