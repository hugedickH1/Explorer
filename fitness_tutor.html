<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>學生尋找導師 (健身、瑜珈及普拉提) </title>

  <style>
    :root{
      --bg: #000000; /* ✅ ONLY changed: background to black */
      --card: #1a1033; /* midnight purple card */
      --muted: #64748b;
      --text: #0f172a;
      --ring: #dbeafe;
      --accent: #0ea5e9;
      --shadow: 0 8px 22px rgba(15,23,42,.08);
      --radius: 16px;
      --modalBg: rgba(2,6,23,.35);
      --tagBg: #e0f2fe;
      --tagBorder: #bae6fd;
      --tagText: #075985;
    }

    *{box-sizing:border-box}
    *::before,*::after{box-sizing:border-box}
    html,body{height:100%}

    /* =========================================================
       ✅ Cross-browser consistency layer (NEW)
       ✅ Makes buttons/selects look identical everywhere
       ========================================================= */
    :where(button, input, select, textarea){
      font: inherit;
      color: inherit;
      letter-spacing: inherit;
    }

    /* remove iOS/Safari native button look */
    button, input[type="button"], input[type="submit"]{
      -webkit-appearance:none;
      appearance:none;
      border:0;
      background:transparent;
      padding:0;
      margin:0;
      line-height:1;
    }

    /* remove default select styling */
    select{
      -webkit-appearance:none;
      -moz-appearance:none;
      appearance:none;
      background-color:#fff;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='none'%3E%3Cpath d='M6 8l4 4 4-4' stroke='%230f172a' stroke-width='1.8' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:16px 16px;
      padding-right:36px;
    }
    select::-ms-expand{display:none;} /* old edge/ie */

    /* search input normalisation */
    input[type="search"]{
      -webkit-appearance:none;
      appearance:none;
    }
    input[type="search"]::-webkit-search-decoration,
    input[type="search"]::-webkit-search-cancel-button,
    input[type="search"]::-webkit-search-results-button,
    input[type="search"]::-webkit-search-results-decoration{
      -webkit-appearance:none;
    }

    /* prevent SVG baseline weird spacing in some browsers */
    svg{display:block}

    /* reduce weird tap highlight on mobile */
    :where(button, a, input, select){
      -webkit-tap-highlight-color: transparent;
    }

    /* Make all key buttons same height everywhere */
    .btn, .pagebtn, .filter-apply-btn, .apply-btn{
      min-height:40px;
      line-height:1;
      font-weight:600;
    }

    /* consistent focus ring across browsers */
    .btn:focus-visible,
    .pagebtn:focus-visible,
    .filter-apply-btn:focus-visible,
    .apply-btn:focus-visible{
      outline:none;
      box-shadow: var(--shadow), 0 0 0 3px rgba(167,139,250,.32);
    }

    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, -apple-system, "Noto Sans TC", system-ui, "PingFang TC", "Microsoft JhengHei", Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); /* ✅ ONLY changed: black */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: geometricPrecision;
    }
    .container{max-width:1200px; margin:26px auto 80px; padding:0 20px;}

    header{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:wrap;
    }
    .title{display:flex; align-items:center; gap:10px;}
    .title h1{
      margin:0; font-size:clamp(20px,2.3vw,28px); letter-spacing:.4px;
      background:linear-gradient(90deg,#0f172a,#0369a1);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }

    /* 按鈕列 */
    .toolbar{
      display:flex; gap:10px; align-items:center;
      justify-content:flex-end; flex-wrap:wrap;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--ring);
      background:#EDE9FE; /* ✅ pale purple button */
      color:#0f172a;
      cursor:pointer;
      transition: transform .06s ease, border-color .2s, background .2s;
      box-shadow:var(--shadow);
      white-space:nowrap;
      font-size:14px;
      user-select:none;
    }
    .btn:hover{ border-color:#C4B5FD; background:#DDD6FE }
    .btn:active{ transform: scale(.98);}

    .filter-btn{display:none;}
    .desktop-only{display:inline-flex;}

    .filter-icon{
      display:inline-flex;
      width:16px; height:16px;
      margin-right:6px;
      flex:0 0 auto;
    }
    .filter-icon svg{width:100%; height:100%;}

    /* ✅ ONLY changed: main toolbar buttons (desktop + mobile) to your requested colours */
    #typeBtn, #shuffle, #resetAll, #filterOpen{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.18);
      color: #F8FAFC;
    }
    #typeBtn:hover, #shuffle:hover, #resetAll:hover, #filterOpen:hover{
      background: rgba(255,255,255,.14);
      border-color: #a78bfa;
    }
    /* ✅ make filter icon visible on dark button */
    #filterOpen .filter-icon svg path{ stroke:#F8FAFC !important; }

    .filter-row{ margin:16px 0 12px; }

    .filters{
      display:grid;
      gap:10px;
      grid-template-columns: 1.1fr 1.1fr 1fr 1fr;
    }

    .search-row{
      display:grid;
      grid-template-columns: 1.1fr 1.1fr;
      gap:10px;
      margin:10px 0 10px;
    }

    .filters .field,
    .search-row .field{display:flex; flex-direction:column; gap:6px}
    .label{font-size:12px; color:#334155}
    .mini{font-size:12px; color:#334155}

    /* ✅ words on the (black) background -> white */
    .filter-row .label,
    .filter-row .mini{ color:#FFFFFF; }
    .meta{ color:#FFFFFF; }
    .pageinfo{ color:#FFFFFF; }
    .active-bar .mini{ color:#FFFFFF; }

    select, input[type="search"], input[type="text"]{
      width:100%; padding:10px 12px;
      border-radius:12px; border:1px solid var(--ring);
      background:#fff; color:#0f172a;
      box-shadow:var(--shadow);
      outline:none;
      transition:border-color .2s, box-shadow .2s;
      font-size:14px;
    }
    select:focus, input:focus{
      border-color: var(--accent);
      box-shadow:0 0 0 3px rgba(14,165,233,.18)
    }

    .slider-row{display:flex; gap:16px; align-items:flex-start}
    .slider-col{display:flex; flex-direction:column; gap:6px; flex:1}

    /* ✅ ONLY changed: style the fee range bars to fit black page
       ✅ AND: track is white until user slides, then filled part uses button colour
    */
    .slider-col input[type="range"]{
      width:100%;
      -webkit-appearance:none;
      appearance:none;
      height:16px;
      background:transparent;
      margin:0;
      padding:0;

      /* fill matches .btn background */
      --fill: #EDE9FE;
      /* default (before user touches) will be forced to 0% by JS */
      --pct: 0%;
    }

    /* ✅ ONLY changed: bar more solid (track) */
    .slider-col input[type="range"]::-webkit-slider-runnable-track{
      height:6px;
      border-radius:999px;
      background:
        linear-gradient(to right,
          var(--fill) 0%,
          var(--fill) var(--pct),
          #ffffff var(--pct),
          #ffffff 100%
        );
      border:1px solid rgba(196,181,253,.55);
      box-shadow:none;
    }
    .slider-col input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:16px;
      height:16px;
      border-radius:999px;
      background:#a78bfa;
      border:2px solid rgba(255,255,255,.88);
      box-shadow:0 8px 18px rgba(0,0,0,.45);
      margin-top:-6px; /* center on 6px track */
      cursor:pointer;
    }

    /* ✅ ONLY changed: bar more solid (track) */
    .slider-col input[type="range"]::-moz-range-track{
      height:6px;
      border-radius:999px;
      background:
        linear-gradient(to right,
          var(--fill) 0%,
          var(--fill) var(--pct),
          #ffffff var(--pct),
          #ffffff 100%
        );
      border:1px solid rgba(196,181,253,.55);
      box-shadow:none;
    }
    .slider-col input[type="range"]::-moz-range-thumb{
      width:16px;
      height:16px;
      border-radius:999px;
      background:#a78bfa;
      border:2px solid rgba(255,255,255,.88);
      box-shadow:0 8px 18px rgba(0,0,0,.45);
      cursor:pointer;
    }
    .slider-col input[type="range"]:focus-visible{
      outline:none;
    }

    #feeBand{
      display:none;
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--ring);
      background:#fff;
      box-shadow:var(--shadow);
      color:var(--text);
      font-size:14px;
    }

    .meta{
      display:flex; align-items:center; gap:10px;
      margin:10px 2px 18px;
      font-size:14px;
    }

    .active-bar{
      display:flex; gap:8px; align-items:center;
      flex-wrap:wrap; margin:8px 0 16px;
    }
    .hidden{display:none;}
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--tagBorder); background:var(--tagBg); color:var(--tagText);
      box-shadow:var(--shadow);
    }
    .chip .x{
      border:none; background:transparent; cursor:pointer;
      font-size:14px; line-height:1;
      color:#0c4a6e; padding:0 2px 0 0;
    }

    .grid{display:grid; grid-template-columns: repeat(3, 1fr); gap:16px;}
    @media (max-width:980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:560px){ .grid{grid-template-columns: 1fr;} }

    .card{
      background: var(--card);
      border:1px solid rgba(196,181,253,.22);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
      transition: transform .15s ease, border-color .2s;
      cursor:pointer;
    }
    .card:hover{ transform: translateY(-3px); border-color: rgba(196,181,253,.55) }
    .card:focus{
      outline: none; border-color: rgba(196,181,253,.75);
      box-shadow:0 0 0 3px rgba(167,139,250,.28)
    }

    .top{display:flex; align-items:center; gap:12px; margin-bottom:10px;}
    .avatar{
      width:38px; height:38px; border-radius:50%;
      display:grid; place-items:center;
      color:#fff; font-weight:800; letter-spacing:.5px;
      border: 1px solid rgba(2,6,23,.08);
    }
    .who{display:flex; flex-direction:column; gap:3px;}
    .who .name{font-weight:700; color: rgba(248,250,252,.96);}
    .who .muted{color: rgba(226,232,240,.78); font-size:13px}

    /* 教練 -> white */
    .card .who .name small{ color:#FFFFFF !important; }

    .row{display:flex; align-items:center; gap:8px; margin:8px 0; color: rgba(226,232,240,.92); font-size:14px}
    .row svg{opacity:.95}
    .card .row svg path{ stroke: #a78bfa !important; }
    .card .row svg circle{ fill: #a78bfa !important; }

    .tags{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}

    /* HK$ number + /時 -> white */
    .tag{
      font-size:12px; padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(196,181,253,.26);
      background: rgba(167,139,250,.14);
      color:#FFFFFF;
    }

    .foot{
      margin-top:12px;
      display:flex; align-items:center; justify-content:space-between;
      gap:8px; color: rgba(226,232,240,.68); font-size:13px;
    }

    /* HK$ xx/時 -> white */
    .budget{color:#FFFFFF; font-weight:700}

    .note{margin-top:10px; color: rgba(226,232,240,.84); font-size:14px; line-height:1.5}

    .empty{
      grid-column:1/-1; text-align:center; padding:40px 16px;
      color:#64748b; border:1px dashed var(--ring);
      border-radius:var(--radius); background:#fff;
    }

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:var(--modalBg);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      padding:0;
    }
    .modal-backdrop.show{display:flex}

    .modal{
      position:relative;
      max-width:1100px;
      width:calc(100% - 40px);
      max-height:calc(100vh - 40px);
      margin:20px;
      background:#ffffff;
      border:1px solid var(--ring);
      border-radius:22px;
      box-shadow:0 25px 70px rgba(0,0,0,.20);
      overflow:auto;
    }

    /* ===== 立即申請！ ===== */
    .apply-btn{
      padding:8px 16px;
      border-radius:999px;
      border:none;
      background:#22c55e;
      color:#ffffff;
      font-size:14px;
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      transition:background .15s ease, transform .06s ease, box-shadow .15s ease;
      white-space:nowrap;
      user-select:none;
    }
    .apply-btn:hover{background:#16a34a;}
    .apply-btn:active{
      transform:scale(.97);
      box-shadow:0 4px 14px rgba(22,163,74,.35);
    }

    .modal header{
      padding:18px 20px 0 20px !important;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      position:relative;
    }
    .modal .close{
      border:none;
      background:transparent;
      color:#1e40af;
      cursor:pointer;
      font-size:22px;
      position:absolute;
      top:14px;
      right:18px;
    }
    .modal header .apply-btn{
      margin-right:40px;
    }

    .modal-head-left{
      display:flex;
      align-items:flex-start;
      gap:10px;
      min-width:0;
    }

    .modal .body{padding: 4px 32px 24px}

    .profile-grid{
      display:grid; grid-template-columns: 1.2fr 1fr;
      gap:18px; margin-top:6px;
    }
    .profile-card{
      background:#f8fafc; border:1px solid var(--ring);
      border-radius:16px; padding:14px;
    }
    .profile-title{margin:0 0 8px 0; font-size:15px; color:#0369a1}
    .kv{
      display:grid; grid-template-columns: 120px 1fr;
      gap:8px 12px; font-size:14px;
    }
    .kv b{color:#0f172a; font-weight:600}
    .cta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .copy{
      cursor:pointer; border:1px solid var(--ring);
      background:#ffffff; color:#0f172a;
      padding:8px 10px; border-radius:10px;
      box-shadow:var(--shadow);
    }
    .copy:hover{border-color:#93c5fd; background:#f0f9ff}
    @media (max-width:560px){
      .profile-grid{
        grid-template-columns:1fr;
        justify-items:center;
      }
      .profile-card{
        max-width:520px;
        width:100%;
      }
    }

    .pager{
      display:flex; align-items:center; justify-content:center;
      gap:10px; margin-top:16px; flex-wrap:wrap;
    }

    /* ✅ ONLY changed: pager button + page text size (match your music page) */
    .pagebtn{
      border:1px solid var(--ring); background:#fff;
      padding:10px 14px;
      border-radius:12px;
      cursor:pointer;
      font-size:14px;
      line-height:1;
      user-select:none;
    }
    .pagebtn[disabled]{opacity:.5; cursor:not-allowed}
    .pageinfo{
      font-size:14px;
      line-height:1;
    }

    .subgrid{
      display:grid; grid-template-columns: repeat(3, minmax(0,1fr));
      gap:8px 12px; margin-top:10px;
    }
    .subgrid label{
      display:flex; gap:8px; align-items:center;
      font-size:13px; color:#0f172a;
    }
    .subgrid input{width:16px; height:16px}
    .line{border:none; border-top:1px solid var(--ring); margin:12px 0}
    .bar{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .fw{width:100%}

    @media (max-width:560px){
      .toolbar{
        width:100%;
        display:grid;
        grid-template-columns: repeat(2, minmax(0,1fr));
        gap:8px;
        margin-top:8px;
      }
      .toolbar .btn{ width:100%; }
      #resetAll{ grid-column:1 / -1; }
      .filter-btn{ display:inline-flex; }
      .desktop-only{ display:none; }

      .search-row{
        display:flex;
        gap:8px;
        margin:10px 0 10px;
      }
      .search-row .field{flex:1;}

      .modal header{
        padding:18px 16px 0 16px !important;
      }
    }

    .filter-panel{
      width:100%;
      max-width:640px;
      margin:0 auto;
      background:#f8fafc;
      border-radius:18px 18px 0 0;
      box-shadow:0 -16px 40px rgba(15,23,42,.3);
    }
    .filter-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:16px 18px 6px;
    }
    .filter-title{
      margin:0;
      font-size:18px;
      color:#0f172a;
      font-weight:400;
    }
    .filter-header-right{
      display:flex;
      align-items:center;
      gap:8px;
    }

    /* ✅ ONLY changed:「套用篩選」button style to match desktop button style */
    .filter-apply-btn{
      padding:10px 14px;
      border-radius:12px;
      border:1px solid rgba(196,181,253,.35);
      background:#EDE9FE;
      color:#0f172a;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:var(--shadow);
      transition: transform .06s ease, border-color .2s, background .2s;
      user-select:none;
    }
    .filter-apply-btn:hover{ background:#DDD6FE; border-color:#C4B5FD; }
    .filter-apply-btn:active{ transform: scale(.98); }

    .filter-close{
      border:none;
      background:transparent;
      font-size:24px;
      cursor:pointer;
      color:#0f172a;
    }
    .filter-body{ padding:4px 18px 14px; }

    @media (max-width:560px){
      #filterBackdrop.modal-backdrop{
        align-items:flex-end;
        justify-content:center;
        padding:0;
      }

      .filters{display:none;}
      .filter-panel .filters{
        display:grid;
        grid-template-columns:1fr;
        gap:10px;
        margin:6px 0 6px;
      }

      .fee-label{ font-size:0; }
      .fee-label::before{
        content:"價位區間";
        font-size:12px;
        color:#334155;
      }

      .slider-row, #feeLabel{ display:none; }
      #feeBand{ display:block; }

      .subgrid{
        grid-template-columns:1fr;
        max-height:260px;
        overflow-y:auto;
        padding-right:4px;
      }
      .subgrid label span{
        white-space:nowrap;
        overflow:hidden;
        text-overflow:ellipsis;
      }

      /* ✅ ONLY changed: make「種類篩選」label-to-button gap same as other fields */
      #filterPanelBody .mobile-subject-row{
        display:flex;
        flex-direction:column;
        gap:6px;
        margin-top:10px;
      }

      /* ✅ ONLY changed: make「開啟種類篩選」look like the white select input */
      #filterBackdrop #mobileTypeBtn{
        width:100%;
        padding:10px 12px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,.18);
        background:#FFFFFF;
        color:#0f172a;
        justify-content:flex-start; /* left align */
        text-align:left;
        box-shadow:var(--shadow);
        font-size:14px;
      }
      #filterBackdrop #mobileTypeBtn:hover{
        background:#F8FAFC;
        border-color:#C4B5FD;
      }
    }

    @media (min-width:561px){
      .filter-row{
        display:grid;
        grid-template-columns: 1.1fr 1.1fr 1fr 1fr 1fr;
        gap:10px;
        align-items:flex-start;
        margin:16px 0 12px;
      }
      .filter-row .filters,
      .filter-row .search-row{
        display:contents;
        margin:0;
      }
      .filter-row .label,
      .filter-row .mini{ white-space:nowrap; }

      .filter-row .filters .field:nth-child(1){ grid-column:1; grid-row:1; }
      .filter-row .filters .field:nth-child(2){ grid-column:2; grid-row:1; }
      .filter-row .filters .field:nth-child(3){ grid-column:5; grid-row:1; }
      .filter-row .search-row .field:nth-child(1){ grid-column:3; grid-row:1; }
      .filter-row .search-row .field:nth-child(2){ grid-column:4; grid-row:1; }
    }

    .filter-row .label,
    .filter-row .mini{ white-space:nowrap; }

    /* =========================
       Banner ONLY — SAME SIZE as your banner
       ========================= */
    .banner{
      position:relative;
      width:100%;
      border-radius:22px;
      overflow:hidden;
      padding:22px 20px;
      margin-bottom:14px;

      --accent: #a78bfa;

      border:1.2px solid transparent;
      background:
        radial-gradient(700px 220px at 12% 20%, rgba(167,139,250,.22), transparent 62%) padding-box,
        radial-gradient(520px 220px at 85% 35%, rgba(196,181,253,.14), transparent 65%) padding-box,
        linear-gradient(135deg, #1a1033 0%, #140a2b 45%, #0f071f 100%) padding-box,

        linear-gradient(135deg,
          rgba(167,139,250,.72) 0%,
          rgba(196,181,253,.50) 45%,
          rgba(167,139,250,.46) 100%
        ) border-box;

      box-shadow:
        0 10px 26px rgba(15,23,42,.10),
        0 1px 0 rgba(255,255,255,.10) inset;
    }

    .banner::before{
      content:"";
      position:absolute;
      inset:1px;
      border-radius:21px;
      background:
        radial-gradient(520px 200px at 18% 10%, rgba(255,255,255,.16), transparent 60%),
        radial-gradient(420px 220px at 85% 0%, rgba(255,255,255,.10), transparent 62%);
      opacity:.60;
      pointer-events:none;
    }
    .banner::after{
      content:"";
      position:absolute;
      inset:1px;
      border-radius:21px;
      background: linear-gradient(180deg, transparent 55%, rgba(2,6,23,.22) 100%);
      pointer-events:none;
    }

    .banner-inner{
      position:relative;
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }

    .banner-title{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:280px;
    }

    .logo-wrap{
      width:46px; height:46px;
      border-radius:14px;
      display:grid; place-items:center;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(196,181,253,.24);
      box-shadow: 0 8px 18px rgba(15,23,42,.22);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      position:relative;
    }
    .logo-wrap::before{
      content:"";
      position:absolute; inset:-10px;
      border-radius:18px;
      background: radial-gradient(circle at 50% 50%, rgba(167,139,250,.22), transparent 62%);
      pointer-events:none;
    }

    .book{ width:28px; height:28px; position:relative; z-index:1; }
    .book path{
      stroke:#c4b5fd;
      stroke-width:1.7;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .book{
      filter:
        drop-shadow(0 6px 12px rgba(0,0,0,.30))
        drop-shadow(0 0 10px rgba(167,139,250,.16));
    }

    .banner-text h1{
      margin:0;
      font-size:clamp(22px, 2.5vw, 30px);
      letter-spacing:.3px;
      line-height:1.08;
      color: rgba(248,250,252,.96);
    }
    .banner-text h1 .accent{
      color: var(--accent, #a78bfa);
      font-weight:900;
    }
    .banner-text p{
      margin:7px 0 0;
      color: rgba(226,232,240,.82);
      font-size:13.5px;
      line-height:1.45;
      max-width:680px;
    }

    /* ✅ ONLY changed: Tablet buttons placement same as Desktop (buttons UNDER title/subtitle) */
    @media (min-width:561px) and (max-width:980px){
      .banner-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .banner .toolbar{
        width:100%;
        justify-content:flex-start;
        margin-top:14px;
      }
    }

    /* ✅ Desktop: buttons UNDER title/subtitle (existing behaviour kept) */
    @media (min-width:981px){
      .banner{
        padding:30px 28px;
        margin-bottom:26px;
      }
      .banner-inner{
        flex-direction:column;
        align-items:flex-start;
      }
      .banner .toolbar{
        width:100%;
        justify-content:flex-start;
        margin-top:14px;
      }
    }

    /* ✅ ONLY changed: when open「種類篩選」& 手機「篩選」底板 -> black bg + white text */
    #typeBackdrop .modal{
      background:#000000;
      border:1px solid rgba(255,255,255,.18);
    }
    #typeBackdrop #typeTitle{ color:#FFFFFF !important; }
    #typeBackdrop .close{ color:#FFFFFF !important; }
    #typeBackdrop .mini,
    #typeBackdrop .subgrid label{ color:#FFFFFF !important; }

    #filterBackdrop .filter-panel{
      background:#000000;
      border:1px solid rgba(255,255,255,.18);
    }
    #filterBackdrop .filter-title,
    #filterBackdrop .filter-close,
    #filterBackdrop .label,
    #filterBackdrop .mini{ color:#FFFFFF !important; }
    #filterBackdrop .fee-label::before{ color:#FFFFFF !important; }
    #filterBackdrop select,
    #filterBackdrop input[type="search"],
    #filterBackdrop input[type="text"],
    #filterBackdrop #feeBand{
      border-color: rgba(255,255,255,.18);
    }

    /* ✅ ONLY changed: Card Profile Modal (#backdrop) -> black bg + white text */
    #backdrop .modal{
      background:#000000;
      border:1px solid rgba(255,255,255,.18);
      color:#FFFFFF;
    }
    #backdrop .modal header{ color:#FFFFFF; }
    #backdrop .modal .close{ color:#FFFFFF !important; }

    #backdrop .profile-card{
      background:#000000;
      border:1px solid rgba(255,255,255,.18);
      color:#FFFFFF;
    }
    #backdrop .profile-title{ color:#FFFFFF !important; }
    #backdrop .kv,
    #backdrop .kv div,
    #backdrop #kv-notes{ color:#FFFFFF !important; }
    #backdrop .kv b{
      color:#FFFFFF !important;
      font-weight:600;
    }

    /* ✅ ONLY changed: 複製教練編號 button -> white */
    #backdrop .copy{
      background:#FFFFFF;
      border:1px solid rgba(196,181,253,.26);
      color:#0f172a;
    }
    #backdrop .copy:hover{
      background:#F8FAFC;
      border-color: rgba(196,181,253,.55);
    }
  </style>
</head>

<body>
  <div class="container">

    <!-- ===== Banner (buttons combined here) ===== -->
    <div class="banner">
      <div class="banner-inner">
        <div class="banner-title">
          <span class="logo-wrap" aria-hidden="true">
            <!-- Dumbbell icon -->
            <svg class="book" viewBox="0 0 24 24" fill="none">
              <path d="M4 10v4"/>
              <path d="M6 9v6"/>
              <path d="M18 9v6"/>
              <path d="M20 10v4"/>
              <path d="M6 12h12"/>
            </svg>
          </span>

          <div class="banner-text">
            <h1>尋找導師 <span class="accent">（健身）</span></h1>
            <p>提供健身與瑜伽導師，幫助學生養成健康生活</p>
          </div>
        </div>

        <div class="toolbar">
          <button id="filterOpen" class="btn filter-btn">
            <span class="filter-icon" aria-hidden="true">
              <svg viewBox="0 0 24 24">
                <path d="M4 5h16M7 11h10M10 17h4" stroke="#0f172a" stroke-width="1.6" stroke-linecap="round"/>
              </svg>
            </span>
            篩選
          </button>

          <button id="typeBtn" class="btn desktop-only">種類篩選</button>
          <button id="shuffle" class="btn">重新隨機</button>
          <button id="resetAll" class="btn">重設所有篩選</button>
        </div>
      </div>
    </div>

    <section class="filter-row" aria-label="篩選與搜尋">
      <div class="filters" aria-label="篩選條件">
        <div class="field">
          <span class="label">地區 / 網上授課</span>
          <select id="district">
            <option value="">全部地區</option>
            <option>網上授課</option>
            <option>中西區</option><option>灣仔區</option><option>東區</option><option>南區</option>
            <option>油尖旺區</option><option>深水埗區</option><option>九龍城區</option><option>黃大仙區</option><option>觀塘區</option>
            <option>葵青區</option><option>荃灣區</option><option>屯門區</option><option>元朗區</option><option>北區</option><option>大埔區</option>
            <option>沙田區</option><option>西貢區</option><option>離島區</option>
          </select>
        </div>

        <div class="field">
          <span class="label fee-label">價位區間（HK$/時）</span>
          <div class="slider-row">
            <div class="slider-col">
              <span class="mini">價位下限</span>
              <input id="feeMin" type="range" min="0" max="1000" step="10" />
            </div>
            <div class="slider-col">
              <span class="mini">價位上限</span>
              <input id="feeMax" type="range" min="0" max="1000" step="10" />
            </div>
          </div>
          <div class="label" id="feeLabel">HK$ 0 – 1000</div>

          <select id="feeBand">
            <option value="">全部價位</option>
            <option value="0-100">HK$0–100/小時</option>
            <option value="100-200">HK$100–200/小時</option>
            <option value="200-300">HK$200–300/小時</option>
            <option value="300-400">HK$300–400/小時</option>
            <option value="400+">HK$400以上/小時</option>
          </select>
        </div>

        <div class="field">
          <span class="label">導師性別篩選</span>
          <select id="genderFilter">
            <option value="">不限教練性別</option>
            <option value="男">男教練</option>
            <option value="女">女教練</option>
          </select>
        </div>
      </div>

      <div class="search-row" aria-label="搜尋">
        <div class="field">
          <span class="label">關鍵字搜尋</span>
          <input id="q" type="search" placeholder="教練姓名 / 類別 / 備註…" />
        </div>

        <div class="field">
          <span class="label">教練編號搜尋</span>
          <input id="idq" type="text" placeholder="輸入教練編號（如：TCH-202511-003）" />
        </div>
      </div>
    </section>

    <div id="activeBar" class="active-bar hidden" aria-live="polite"></div>

    <div class="meta" id="count">載入中…</div>

    <section id="grid" class="grid" aria-live="polite" aria-busy="true"></section>

    <div class="pager">
      <button id="prevPage" class="pagebtn">上一頁</button>
      <span id="pageInfo" class="pageinfo">第 1 / 1 頁</span>
      <button id="nextPage" class="pagebtn">下一頁</button>
    </div>
  </div>

  <!-- 完整個案 Modal -->
  <div id="backdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="modalTitle">
      <header>
        <div class="modal-head-left">
          <div id="modalAvatar" class="avatar" style="width:44px;height:44px"></div>
          <div style="min-width:0">
            <h2 id="modalTitle" style="margin:0; font-size:20px"></h2>
            <div id="modalSub" class="who muted" style="margin-top:4px"></div>
          </div>
        </div>

        <a
          href="https://forms.gle/E746boJXjZvdT4fN6"
          target="_blank"
          rel="noopener noreferrer"
          class="apply-btn"
        >立即申請！</a>

        <button class="close" id="modalClose" aria-label="關閉">✕</button>
      </header>

      <div class="body">
        <div class="profile-grid">
          <div class="profile-card">
            <h3 class="profile-title">基本資料</h3>
            <div class="kv" id="kv-basic"></div>
            <div class="cta-row">
              <button id="copyId" class="copy">複製教練編號</button>
            </div>
          </div>
          <div class="profile-card">
            <h3 class="profile-title">課程期望 / 招生資料</h3>
            <div class="kv" id="kv-expect"></div>
          </div>
          <div class="profile-card" style="grid-column:1/-1">
            <h3 class="profile-title">課程備註 / 教學重點</h3>
            <div id="kv-notes" style="white-space:pre-wrap; line-height:1.7; font-size:14px"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 種類篩選 Modal -->
  <div id="typeBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="typeTitle">
      <header style="padding:18px 32px 8px">
        <h2 id="typeTitle" style="margin:0; font-size:20px; color:#0369a1"; font-weight:400>種類篩選</h2>
        <button class="close" id="typeClose" aria-label="關閉">✕</button>
      </header>
      <div class="body" style="padding:4px 32px 20px">
        <div class="mini">勾選需要的種類（可複選）。未勾選即視為不限種類。</div>
        <div id="typeList" class="subgrid"></div>
        <div class="bar">
          <button id="typeSelAll" class="btn">全選</button>
          <button id="typeClrAll" class="btn">清除全部</button>
          <span id="typeSelCount" class="mini fw">已選：0 種類</span>
        </div>
        <div class="bar" style="justify-content:flex-end; margin-top:12px">
          <button id="applyType" class="btn">套用篩選</button>
        </div>
      </div>
    </div>
  </div>

  <!-- 手機「篩選」底板 -->
  <div id="filterBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="filter-panel" role="document" aria-labelledby="filterTitle">
      <div class="filter-header">
        <h2 id="filterTitle" class="filter-title">篩選條件</h2>
        <div class="filter-header-right">
          <button id="filterApply" class="filter-apply-btn">套用篩選</button>
          <button id="filterClose" class="filter-close" aria-label="關閉">✕</button>
        </div>
      </div>
      <div class="filter-body" id="filterPanelBody">
        <div class="field mobile-subject-row">
          <span class="label">種類篩選</span>
          <button id="mobileTypeBtn" class="btn" style="padding-inline:12px">開啟種類篩選</button>
        </div>
      </div>
    </div>
  </div>

  <script>
'use strict';
(function(){
  const TYPES_ALL = [
    "業餘健身","職業健身比賽訓練","職業健力比賽訓練",
    "瑜珈","普拉提","有氧訓練","HYROX訓練","街頭健身"
  ];

  const CASES = [
    { id:"TCH-202511-001", name:"Alex",   gender:"男", age:32, exp:"5 年私人教練 · 減脂塑形", district:"沙田區", modes:["上門教學","到教練指定地方"], fee:550, weeklyLessons:2, lessonLength:1.5, types:["業餘健身","有氧訓練"], timePref:"平日 19:00 後；週末下午", notes:"專長體脂管理及肌耐力訓練，適合初學者及重返運動的上班族。", postedDate:"2025-11-15" },
    { id:"TCH-202511-002", name:"Carmen", gender:"女", age:29, exp:"RYT200 認證 · 流瑜珈", district:"網上授課", modes:["網上教學"], fee:420, weeklyLessons:3, lessonLength:1, types:["瑜珈"], timePref:"一三五 20:00–21:00", notes:"提供伸展及舒緩課程，特別適合久坐族、學生考試壓力族。", postedDate:"2025-11-12" },
    { id:"TCH-202511-003", name:"Marcus", gender:"男", age:30, exp:"7 年街頭健身 · 自體重訓練", district:"觀塘區", modes:["到教練指定地方"], fee:500, weeklyLessons:2, lessonLength:2, types:["街頭健身"], timePref:"週末全天可；平日晚間可議", notes:"專攻引體向上、平衡技巧及核心訓練，適合想挑戰動作難度的學生。", postedDate:"2025-11-18" },
    { id:"TCH-202511-004", name:"Irene",  gender:"女", age:38, exp:"產後復康 · 普拉提教學 4 年", district:"荃灣區", modes:["上門教學"], fee:600, weeklyLessons:2, lessonLength:1.5, types:["普拉提","有氧訓練"], timePref:"二四 10:00–11:30", notes:"專為產後媽媽及核心較弱人士設計，著重骨盆底及姿勢調整。", postedDate:"2025-11-10" },
    { id:"TCH-202511-005", name:"Leo",    gender:"男", age:27, exp:"大學校隊體能教練", district:"九龍城區", modes:["到教練指定地方","網上教學"], fee:450, weeklyLessons:2, lessonLength:1.5, types:["業餘健身","HYROX訓練"], timePref:"二四 19:30 後", notes:"適合準備 HYROX、功能性體能賽及想提升心肺能力的學生。", postedDate:"2025-11-20" },
    { id:"TCH-202511-006", name:"Selina", gender:"女", age:31, exp:"3 年普拉提床及墊上課", district:"灣仔區", modes:["到教練指定地方"], fee:650, weeklyLessons:1, lessonLength:2, types:["普拉提"], timePref:"六 14:00–16:00", notes:"擅長協助長期腰痛、圓肩及久坐姿勢問題，著重動作控制與呼吸節奏。", postedDate:"2025-11-08" },
    { id:"TCH-202511-007", name:"Ray",    gender:"男", age:28, exp:"健力比賽選手 · 深蹲/硬舉專項", district:"深水埗區", modes:["到教練指定地方"], fee:700, weeklyLessons:3, lessonLength:2, types:["職業健力比賽訓練"], timePref:"一三五 18:30–20:30", notes:"專為想參加健力比賽或提升三大項數字的學生設計，包含週期化訓練。", postedDate:"2025-11-21" },
    { id:"TCH-202511-008", name:"Vicky",  gender:"女", age:35, exp:"瑜珈及伸展 · 上班族體態調整", district:"葵青區", modes:["上門教學","網上教學"], fee:380, weeklyLessons:2, lessonLength:1, types:["瑜珈","有氧訓練"], timePref:"二四 21:00–22:00", notes:"側重肩頸放鬆、下背疲勞及居家簡易流動，無需器材即可開始。", postedDate:"2025-11-09" },
    { id:"TCH-202511-009", name:"Jason",  gender:"男", age:33, exp:"比賽備戰教練 · Cross training", district:"中西區", modes:["到教練指定地方"], fee:780, weeklyLessons:2, lessonLength:1.5, types:["職業健身比賽訓練","HYROX訓練"], timePref:"二四晚或週末下午", notes:"帶學生備戰業餘健美賽，包含飲食規劃及高強度間歇訓練。", postedDate:"2025-11-17" },
    { id:"TCH-202511-010", name:"Queenie",gender:"女", age:26, exp:"女性重訓入門 · 體態雕塑", district:"元朗區", modes:["上門教學"], fee:420, weeklyLessons:2, lessonLength:1, types:["業餘健身"], timePref:"三五 19:00–20:00", notes:"專門教授女生自由重量入門、安全架設及下半身訓練，適合零經驗學生。", postedDate:"2025-11-11" }
  ];

  const $  = s => document.querySelector(s);

  function shuffle(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i],a[j]] = [a[j],a[i]];
    }
    return a;
  }

  function esc(str){
    return String(str ?? "").replace(/[&<>"'`=\/]/g, s => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
    }[s] || s));
  }

  function colorFromName(name){
    let h=0;
    for(let i=0;i<name.length;i++){
      h = (h*31 + name.charCodeAt(i)) % 360;
    }
    return `hsl(${h} 70% 50%)`;
  }
  function scrollToTop(){
    try{ window.scrollTo({top:0,behavior:'smooth'}); }
    catch{ window.scrollTo(0,0); }
  }
  function parseISODate(s){
    const m = String(s||'').match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    const y=+m[1], mm=+m[2]-1, d=+m[3];
    const dt = new Date(Date.UTC(y,mm,d));
    return isNaN(dt)? null : dt;
  }
  function deriveDateFromId(id){
    const m = String(id||'').match(/-(\d{4})(\d{2})-(\d{3})$/);
    if(!m) return null;
    const y=+m[1], mm=+m[2]-1, seq=+m[3];
    const day = (seq % 28) + 1;
    const dt = new Date(Date.UTC(y,mm,day));
    return isNaN(dt)? null : dt;
  }
  function tsOf(c){
    const d = c.postedDate ? parseISODate(c.postedDate) : deriveDateFromId(c.id);
    return d ? d.getTime() : 0;
  }
  function fmtDate(ts){
    if(!ts) return "—";
    const d = new Date(ts);
    const y=d.getUTCFullYear();
    const m=String(d.getUTCMonth()+1).padStart(2,'0');
    const dd=String(d.getUTCDate()).padStart(2,'0');
    return `${y}/${m}/${dd}`;
  }

  function setRangeFill(r){
    if(!r) return;
    const min = Number(r.min ?? 0);
    const max = Number(r.max ?? 100);
    const val = Number(r.value ?? 0);
    const pct = (max === min) ? 0 : ((val - min) / (max - min)) * 100;
    r.style.setProperty('--pct', `${Math.max(0, Math.min(100, pct))}%`);
  }

  const grid        = $('#grid');
  const countEl     = $('#count');
  const q           = $('#q');
  const idq         = $('#idq');
  const districtSel = $('#district');
  const feeMin      = $('#feeMin');
  const feeMax      = $('#feeMax');
  const feeLabel    = $('#feeLabel');
  const feeBand     = $('#feeBand');
  const genderFilter= $('#genderFilter');
  const activeBar   = $('#activeBar');

  const backdrop    = $('#backdrop');
  const modalClose  = $('#modalClose');
  const modalAvatar = $('#modalAvatar');
  const modalTitle  = $('#modalTitle');
  const modalSub    = $('#modalSub');
  const kvBasic     = $('#kv-basic');
  const kvExpect    = $('#kv-expect');
  const kvNotes     = $('#kv-notes');
  const copyIdBtn   = $('#copyId');

  const typeBtn     = $('#typeBtn');
  const typeBackdrop= $('#typeBackdrop');
  const typeClose   = $('#typeClose');
  const typeList    = $('#typeList');
  const typeSelAll  = $('#typeSelAll');
  const typeClrAll  = $('#typeClrAll');
  const typeSelCount= $('#typeSelCount');
  const applyType   = $('#applyType');

  const PAGE_SIZE   = 9;
  const prevPageBtn = $('#prevPage');
  const nextPageBtn = $('#nextPage');
  const pageInfo    = $('#pageInfo');
  let currentPage   = 1;
  let sortMode      = 'desc';

  const filterBackdrop   = $('#filterBackdrop');
  const filterOpenBtn    = $('#filterOpen');
  const filterCloseBtn   = $('#filterClose');
  const filterApplyBtn   = $('#filterApply');
  const filterPanelBody  = $('#filterPanelBody');
  const mobileTypeBtn    = $('#mobileTypeBtn');
  const filtersSection   = document.querySelector('.filters');
  const mobileSubjectRow = document.querySelector('.mobile-subject-row');
  const filtersHomeParent     = filtersSection.parentNode;
  const filtersHomeNextSibling= filtersSection.nextElementSibling;
  let filtersInSheet = false;

  let data = CASES.map(c => ({ ...c, _ts: tsOf(c) }));
  data.forEach(c => c._dateStr = fmtDate(c._ts));
  let view = data.slice();

  // ===== Applied types =====
  const typesSelected = new Set();

  // ✅ NEW: draft types (未按「套用篩選」就關閉 -> 不生效)
  let typesDraft = null;
  let typeOpenedFromFilter = false;

  // ===== Fee slider touched =====
  let feeMinTouched = false;
  let feeMaxTouched = false;

  // ✅ NEW: Mobile filter-sheet draft (未按「套用篩選」就關閉 -> 不生效)
  let mobileDraftActive = false;
  let mobileApplied = null;

  function isMobile(){
    return window.innerWidth <= 560;
  }
  function usingMobileApplied(){
    return isMobile() && mobileDraftActive && mobileApplied;
  }

  function captureMobileState(){
    return {
      district: districtSel.value,
      feeBand: feeBand.value,
      feeMin: feeMin.value,
      feeMax: feeMax.value,
      gender: genderFilter.value,
      feeMinTouched: !!feeMinTouched,
      feeMaxTouched: !!feeMaxTouched
    };
  }

  function normalizeFees(){
    let min = Number(feeMin.value), max = Number(feeMax.value);
    if(min > max){
      [min,max] = [max,min];
      feeMin.value = String(min);
      feeMax.value = String(max);
    }
    feeLabel.textContent = `HK$ ${min} – ${max}`;
  }

  function applyMobileState(st){
    if(!st) return;
    districtSel.value = st.district ?? '';
    feeBand.value = st.feeBand ?? '';
    feeMin.value = st.feeMin ?? feeMin.value;
    feeMax.value = st.feeMax ?? feeMax.value;
    genderFilter.value = st.gender ?? '';

    feeMinTouched = !!st.feeMinTouched;
    feeMaxTouched = !!st.feeMaxTouched;

    normalizeFees();
    if(feeMinTouched) setRangeFill(feeMin); else feeMin.style.setProperty('--pct','0%');
    if(feeMaxTouched) setRangeFill(feeMax); else feeMax.style.setProperty('--pct','0%');
  }

  function beginMobileDraft(){
    mobileApplied = captureMobileState();     // freeze applied state
    mobileDraftActive = true;                // now edits are "draft"
  }
  function cancelMobileDraft(){
    if(!mobileDraftActive) return;
    applyMobileState(mobileApplied);         // revert controls back to applied
    mobileDraftActive = false;
  }
  function commitMobileDraft(){
    if(!mobileDraftActive) return;
    mobileApplied = captureMobileState();    // commit edits as applied
    mobileDraftActive = false;
  }

  function initFees(){
    const fees = data.map(x=>x.fee).filter(x=>typeof x==='number');
    const min  = Math.min(...fees, 0);
    const max  = Math.max(...fees, 1000);
    const lo   = Math.floor(min/10)*10;
    const hi   = Math.ceil(max/10)*10;
    feeMin.min = feeMax.min = String(lo);
    feeMin.max = feeMax.max = String(hi);
    feeMin.value = String(lo);
    feeMax.value = String(hi);
    feeLabel.textContent = `HK$ ${feeMin.value} – ${feeMax.value}`;
    feeBand.value = "";

    feeMinTouched = false;
    feeMaxTouched = false;
    feeMin.style.setProperty('--pct','0%');
    feeMax.style.setProperty('--pct','0%');
  }

  // ===== Type modal (draft) =====
  function renderTypeList(){
    const set = (typesDraft ?? typesSelected);
    typeList.innerHTML = '';
    TYPES_ALL.forEach((t, i)=>{
      const id = `type-${i}`;
      const label = document.createElement('label');
      label.innerHTML = `<input type="checkbox" id="${id}"> <span>${esc(t)}</span>`;
      const input = label.querySelector('input');
      input.checked = set.has(t);
      input.addEventListener('change', ()=>{
        const s = (typesDraft ?? typesSelected);
        if(input.checked) s.add(t);
        else s.delete(t);
        typeSelCount.textContent = `已選：${s.size} 種類`;
      });
      typeList.appendChild(label);
    });
    typeSelCount.textContent = `已選：${set.size} 種類`;
  }

  function openTypeModal(){
    // start draft from applied
    typesDraft = new Set(typesSelected);

    typeBackdrop.classList.add('show');
    typeBackdrop.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    renderTypeList();
    typeClose.focus();
  }
  function closeTypeModal(){
    // discard draft if not applied
    typesDraft = null;

    typeBackdrop.classList.remove('show');
    typeBackdrop.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  typeSelAll.addEventListener('click', ()=>{
    const set = (typesDraft ?? typesSelected);
    TYPES_ALL.forEach(t=>set.add(t));
    renderTypeList();
  });
  typeClrAll.addEventListener('click', ()=>{
    const set = (typesDraft ?? typesSelected);
    set.clear();
    renderTypeList();
  });

  applyType.addEventListener('click', ()=>{
    // commit draft -> applied ONLY when pressed
    if(typesDraft){
      typesSelected.clear();
      typesDraft.forEach(t=>typesSelected.add(t));
    }
    currentPage = 1;
    refresh();
    closeTypeModal();

    // phone: after apply types, return to 篩選條件 (filter sheet) if opened from there
    if(typeOpenedFromFilter && isMobile()){
      typeOpenedFromFilter = false;
      openFilterSheet();
    }else{
      typeOpenedFromFilter = false;
    }
  });

  // ===== Mobile filter sheet =====
  function moveFiltersToSheet(){
    if(filtersInSheet) return;
    filterPanelBody.insertBefore(filtersSection, mobileSubjectRow);
    filtersInSheet = true;
  }
  function restoreFiltersHome(){
    if(!filtersInSheet) return;
    if(filtersHomeNextSibling && filtersHomeNextSibling.parentNode === filtersHomeParent){
      filtersHomeParent.insertBefore(filtersSection, filtersHomeNextSibling);
    }else{
      filtersHomeParent.appendChild(filtersSection);
    }
    filtersInSheet = false;
  }

  function openFilterSheet(){
    if(!isMobile()) return;

    // start draft only once (so opening again doesn't overwrite)
    if(!mobileDraftActive){
      beginMobileDraft();
    }

    moveFiltersToSheet();
    filterBackdrop.classList.add('show');
    filterBackdrop.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
  }

  function closeFilterSheet(cancelDraft = true){
    if(window.innerWidth > 560){
      restoreFiltersHome();
    }

    if(cancelDraft){
      cancelMobileDraft();
    }

    filterBackdrop.classList.remove('show');
    filterBackdrop.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }

  if(filterOpenBtn) filterOpenBtn.addEventListener('click', openFilterSheet);

  if(filterCloseBtn) filterCloseBtn.addEventListener('click', ()=> closeFilterSheet(true));

  if(filterApplyBtn){
    filterApplyBtn.addEventListener('click', ()=>{
      // commit & apply
      commitMobileDraft();
      currentPage = 1;
      refresh();
      closeFilterSheet(false);
    });
  }

  if(filterBackdrop){
    filterBackdrop.addEventListener('click', (e)=>{
      if(e.target === filterBackdrop) closeFilterSheet(true);
    });
  }

  if(mobileTypeBtn){
    mobileTypeBtn.addEventListener('click', ()=>{
      // keep draft (do NOT cancel) while switching to type modal
      typeOpenedFromFilter = true;
      closeFilterSheet(false);
      openTypeModal();
    });
  }

  window.addEventListener('resize', ()=>{
    if(window.innerWidth > 560 && filtersInSheet){
      cancelMobileDraft();
      typeOpenedFromFilter = false;

      restoreFiltersHome();
      filterBackdrop.classList.remove('show');
      filterBackdrop.setAttribute('aria-hidden','true');
      document.body.style.overflow = '';
    }
  });

  // ===== Filtering =====
  function passesFee(c){
    const fee = Number(c.fee ?? 0);
    const st = usingMobileApplied() ? mobileApplied : null;

    const band = st ? (st.feeBand || "") : feeBand.value;
    if(band){
      if(band === "0-100")   return fee >= 0   && fee <= 100;
      if(band === "100-200") return fee >= 100 && fee <= 200;
      if(band === "200-300") return fee >= 200 && fee <= 300;
      if(band === "300-400") return fee >= 300 && fee <= 400;
      if(band === "400+")    return fee > 400;
    }

    let min = Number(st ? st.feeMin : feeMin.value);
    let max = Number(st ? st.feeMax : feeMax.value);

    if(min > max){
      [min,max] = [max,min];
      if(!st){
        feeMin.value = String(min);
        feeMax.value = String(max);
      }
    }

    if(!st){
      feeLabel.textContent = `HK$ ${min} – ${max}`;
      if(feeMinTouched) setRangeFill(feeMin);
      if(feeMaxTouched) setRangeFill(feeMax);
    }

    return fee >= min && fee <= max;
  }

  function passesDistrict(c){
    const st = usingMobileApplied() ? mobileApplied : null;
    const d = st ? (st.district || "") : districtSel.value;
    if(!d) return true;
    return c.district === d;
  }

  function passesTypes(c){
    if(typesSelected.size === 0) return true;
    if(!Array.isArray(c.types) || c.types.length===0) return false;
    return c.types.some(t => typesSelected.has(t));
  }

  function passesGender(c){
    const st = usingMobileApplied() ? mobileApplied : null;
    const g = st ? (st.gender || "") : genderFilter.value;
    if(!g) return true;
    return (c.gender || '') === g;
  }

  function passesKeyword(c){
    const k = q.value.trim().toLowerCase();
    if(!k) return true;
    const hay = [
      c.id, c.name, c.gender, c.age, c.exp, c.district,
      (c.types||[]).join('、'), (c.modes||[]).join('、'),
      c.notes, c.timePref,
      String(c.fee ?? ""), String(c.weeklyLessons ?? ""), String(c.lessonLength ?? ""),
      c.postedDate
    ].join(' ').toLowerCase();
    return hay.includes(k);
  }

  function passesId(c){
    const s = idq.value.trim();
    if(!s) return true;
    return (c.id || '').toLowerCase().includes(s.toLowerCase());
  }

  function applyFilters(){
    return data.filter(c =>
      passesFee(c) &&
      passesDistrict(c) &&
      passesTypes(c) &&
      passesGender(c) &&
      passesKeyword(c) &&
      passesId(c)
    );
  }

  function sortByPosted(arr){
    if(sortMode === 'rand') return shuffle(arr);
    return arr.slice().sort((a,b)=> (b._ts || 0) - (a._ts || 0));
  }

  function renderActiveBar(){
    activeBar.innerHTML = '';
    const chips = [];
    typesSelected.forEach(t => chips.push({kind:'type', label:t, value:t}));

    if(chips.length === 0){
      activeBar.classList.add('hidden');
      return;
    }
    activeBar.classList.remove('hidden');

    const hint = document.createElement('span');
    hint.className = 'mini';
    hint.textContent = '已啟用篩選：';
    activeBar.appendChild(hint);

    for(const chipData of chips){
      const chip = document.createElement('span');
      chip.className = 'chip';
      chip.innerHTML =
        `<button class="x" data-kind="${esc(chipData.kind)}" data-value="${esc(chipData.value)}" title="移除此篩選">×</button><span>${esc(chipData.label)}</span>`;
      activeBar.appendChild(chip);
    }
  }

  activeBar.addEventListener('click', e=>{
    const btn = e.target.closest('button.x');
    if(!btn) return;
    const kind = btn.getAttribute('data-kind');
    const val  = btn.getAttribute('data-value');
    if(kind === 'type' && val && typesSelected.has(val)){
      typesSelected.delete(val);
      currentPage = 1;
      refresh();
    }
  });

  function renderList(){
    grid.setAttribute('aria-busy','true');
    grid.innerHTML = '';

    const total      = view.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    currentPage      = Math.min(Math.max(1,currentPage), totalPages);

    const start     = (currentPage - 1) * PAGE_SIZE;
    const end       = Math.min(start + PAGE_SIZE, total);
    const pageSlice = view.slice(start, end);

    if(pageSlice.length === 0){
      const empty = document.createElement('div');
      empty.className = 'empty';
      empty.textContent = '找不到符合條件的案例。請調整篩選或清除搜尋。';
      grid.appendChild(empty);
    }else{
      for(const c of pageSlice){
        const card = document.createElement('article');
        card.className = 'card';
        card.tabIndex = 0;
        const initials    = esc((c.name||'?').slice(0,2));
        const avatarColor = colorFromName(c.name||'');

        const genderText = c.gender ? `${c.gender}教練` : '';

        card.innerHTML = `
          <div class="top">
            <div class="avatar" style="background:${avatarColor};" aria-hidden="true">${initials}</div>
            <div class="who">
              <div class="name">${esc(c.name)}　<small>${esc(genderText)}</small></div>
              <div class="muted">教練編號：${esc(c.id || '-')}</div>
            </div>
          </div>

          <div class="row">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M3 11h18M6 7h12M6 15h12M5 21l2-6m10 6l2-6" stroke="#3b82f6" stroke-width="1.4" stroke-linecap="round"/>
            </svg>
            <span>${esc((c.types||[]).join('、') || '—')}</span>
          </div>

          <div class="row" title="每週堂數 × 每堂時數">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M7 3h10v4H7zM4 7h16v14H4z" stroke="#3b82f6" stroke-width="1.4"/>
            </svg>
            <span>${esc(c.weeklyLessons ?? '—')} 堂／週　·　${esc(c.lessonLength ?? '—')} 小時／堂</span>
          </div>

          <div class="row">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 20s8-4.5 8-11a8 8 0 1 0-16 0c0 6.5 8 11 8 11Z" stroke="#3b82f6" stroke-width="1.4"/>
              <circle cx="12" cy="9" r="2" fill="#3b82f6"/>
            </svg>
            <span>${esc(c.district || '—')}</span>
          </div>

          <div class="tags">
            <span class="tag">學費：HK$ ${esc(c.fee ?? '—')}/時</span>
            <span class="tag">張貼：${esc(c._dateStr || '—')}</span>
            ${(c.modes||[]).map(m=>`<span class="tag">${esc(m)}</span>`).join('')}
          </div>

          ${c.notes ? `<p class="note">${esc(c.notes)}</p>` : ''}

          <div class="foot">
            <span>點擊查看完整個案</span>
            <span class="budget">${(c.fee || c.fee===0) ? `HK$ ${esc(c.fee)}/時` : '面議'}</span>
          </div>
        `;
        card.addEventListener('click', ()=> openProfile(c));
        card.addEventListener('keydown', e=>{
          if(e.key === 'Enter' || e.key === ' '){
            e.preventDefault();
            openProfile(c);
          }
        });
        grid.appendChild(card);
      }
    }

    const shownFrom = total === 0 ? 0 : (start + 1);
    const shownTo   = end;
    countEl.textContent = `符合 ${total} 個招生個案　·　顯示第 ${shownFrom}–${shownTo} 個招生個案`;
    pageInfo.textContent = `第 ${currentPage} / ${Math.max(1, Math.ceil(view.length / PAGE_SIZE))} 頁`;
    grid.removeAttribute('aria-busy');
  }

  let openedCase = null;
  function openProfile(c){
    openedCase = c;
    modalAvatar.style.background = colorFromName(c.name||'?');
    modalAvatar.textContent = (c.name||'?').slice(0,2);

    modalTitle.textContent = `${c.name ?? '—'}`;
    modalSub.textContent = `教練編號：${c.id ?? '—'}`;

    kvBasic.innerHTML = `
      <b>教練性別</b><div>${esc(c.gender ? (c.gender + '教練') : '—')}</div>
      <b>教練年齡</b><div>${esc(c.age!=null? c.age+' 歲':'—')}</div>
      <b>教練／課程簡介</b><div>${esc(c.exp ?? '—')}</div>
      <b>期望授課地區</b><div>${esc(c.district ?? '—')}</div>
      <b>場地安排</b><div>${esc((c.modes||[]).join('、') || '—')}</div>
      <b>課程種類</b><div>${esc((c.types||[]).join('、') || '—')}</div>
      <b>張貼日期</b><div>${esc(c._dateStr || '—')}</div>
    `;
    kvExpect.innerHTML = `
      <b>學費</b><div>HK$ ${esc(c.fee ?? '—')} / 小時</div>
      <b>每週堂數</b><div>${esc(c.weeklyLessons ?? '—')} 堂 / 週</div>
      <b>每堂時數</b><div>${esc(c.lessonLength ?? '—')} 小時 / 堂</div>
      <b>期望時段</b><div>${esc(c.timePref || '—')}</div>
    `;
    kvNotes.textContent = c.notes || '—';

    copyIdBtn.textContent = '複製教練編號';

    backdrop.classList.add('show');
    backdrop.setAttribute('aria-hidden','false');
    document.body.style.overflow = 'hidden';
    modalClose.focus();
  }
  function closeProfile(){
    openedCase = null;
    backdrop.classList.remove('show');
    backdrop.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
  }
  modalClose.addEventListener('click', closeProfile);
  backdrop.addEventListener('click', e=>{
    if(e.target === backdrop) closeProfile();
  });
  document.addEventListener('keydown', e=>{
    if(e.key === 'Escape' && backdrop.classList.contains('show')) closeProfile();
  });

  copyIdBtn.addEventListener('click', async ()=>{
    if(!openedCase) return;
    try{
      if(navigator.clipboard && window.isSecureContext){
        await navigator.clipboard.writeText(openedCase.id || '');
        copyIdBtn.textContent = '已複製！';
      }else{
        throw new Error('no clipboard');
      }
    }catch{
      const ta = document.createElement('textarea');
      ta.value = openedCase.id || '';
      ta.style.position='fixed';
      ta.style.opacity='0';
      document.body.appendChild(ta);
      ta.select();
      try{
        document.execCommand('copy');
        copyIdBtn.textContent = '已複製！';
      }catch{
        copyIdBtn.textContent = '複製失敗，請手動';
      }
      document.body.removeChild(ta);
    }
  });

  $('#shuffle').addEventListener('click', ()=>{
    sortMode = 'rand';
    currentPage = 1;
    refresh();
  });

  $('#resetAll').addEventListener('click', ()=>{
    q.value           = '';
    idq.value         = '';
    districtSel.value = '';
    genderFilter.value= '';
    sortMode          = 'desc';
    typesSelected.clear();
    initFees();

    // keep mobile applied in sync after reset
    mobileApplied = captureMobileState();
    mobileDraftActive = false;

    currentPage = 1;
    refresh();
  });

  // keyword/id search remains instant
  q.addEventListener('input', ()=>{ currentPage=1; refresh(); });
  idq.addEventListener('input', ()=>{ currentPage=1; refresh(); });

  // filters: mobile draft = no refresh until "套用篩選"
  districtSel.addEventListener('change', ()=>{
    if(usingMobileApplied()){
      return;
    }
    currentPage=1; refresh();
  });

  feeMin.addEventListener('input', ()=>{
    feeMinTouched = true; setRangeFill(feeMin); normalizeFees();
    if(usingMobileApplied()){
      return;
    }
    currentPage=1; refresh();
  });
  feeMax.addEventListener('input', ()=>{
    feeMaxTouched = true; setRangeFill(feeMax); normalizeFees();
    if(usingMobileApplied()){
      return;
    }
    currentPage=1; refresh();
  });

  feeBand.addEventListener('change', ()=>{
    if(usingMobileApplied()){
      return;
    }
    currentPage=1; refresh();
  });

  genderFilter.addEventListener('change', ()=>{
    if(usingMobileApplied()){
      return;
    }
    currentPage=1; refresh();
  });

  prevPageBtn.addEventListener('click', ()=>{
    if(currentPage>1){
      currentPage--;
      renderList();
    }
  });
  nextPageBtn.addEventListener('click', ()=>{
    const totalPages = Math.max(1, Math.ceil(view.length / PAGE_SIZE));
    if(currentPage < totalPages){
      currentPage++;
      renderList();
      scrollToTop();
    }
  });

  typeBtn.addEventListener('click', openTypeModal);
  typeClose.addEventListener('click', closeTypeModal);
  typeBackdrop.addEventListener('click', e=>{
    if(e.target === typeBackdrop) closeTypeModal();
  });
  document.addEventListener('keydown', e=>{
    if(e.key === 'Escape' && typeBackdrop.classList.contains('show')) closeTypeModal();
  });

  function refresh(){
    view = applyFilters();
    view = sortByPosted(view);
    renderList();
    renderActiveBar();
  }

  function boot(){
    data = shuffle(data);
    initFees();
    sortMode = 'desc';
    renderTypeList();
    refresh();

    // initial applied snapshot for mobile
    mobileApplied = captureMobileState();
    mobileDraftActive = false;

    if(countEl.textContent === '載入中…') countEl.textContent = '';
  }
  try{
    boot();
  }catch(err){
    console.error(err);
    countEl.textContent = '初始化失敗：' + (err?.message || String(err));
  }
})();
  </script>
</body>
</html>
